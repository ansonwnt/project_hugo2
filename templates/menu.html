{% extends "base.html" %}

{% block title %}Menu{% endblock %}

{% block content %}
<div class="menu-page">
    <!-- Header with View Toggle -->
    <header class="header">
        <h1 class="header-title">Menu</h1>
        <div class="view-toggle">
            <button class="view-btn active" data-view="featured" title="Featured">
                <span>‚ú®</span>
            </button>
            <button class="view-btn" data-view="grid" title="Grid">
                <span>‚äû</span>
            </button>
            <button class="view-btn" data-view="list" title="List">
                <span>‚ò∞</span>
            </button>
            <button class="view-btn" data-view="swipe" title="Swipe">
                <span>üíò</span>
            </button>
        </div>
    </header>

    <!-- Category Tabs -->
    <div class="category-tabs">
        <button class="category-tab active" data-category="all">All</button>
        <button class="category-tab" data-category="beers">üç∫ Beers</button>
        <button class="category-tab" data-category="cocktails">üçπ Cocktails</button>
        <button class="category-tab" data-category="whiskey">ü•É Whiskey</button>
        <button class="category-tab" data-category="softdrinks">ü•§ Softdrinks</button>
        <button class="category-tab" data-category="snacks">üçü Snacks</button>
    </div>

    <!-- Menu Content -->
    <div class="menu-content" id="menu-content">

        <!-- Featured Banner -->
        <div class="featured-banner menu-section" data-category="beers">
            <div class="banner-content">
                <div class="banner-badge">üî• Popular</div>
                <h2 class="banner-title">Guinness</h2>
                <p class="banner-desc">Ireland's finest stout</p>
                <span class="banner-price">30 z≈Ç</span>
            </div>
            <div class="banner-visual coffee-gradient">
                <img src="{{ drinks[0].img.replace('w=96', 'w=400').replace('h=96', 'h=400') }}" alt="Guinness" loading="lazy">
            </div>
        </div>

        {% set cat_labels = {'beers': 'üç∫ Beer & Cider', 'cocktails': 'üçπ Cocktails', 'whiskey': 'ü•É Whiskey', 'softdrinks': 'ü•§ Softdrinks', 'snacks': 'üçü Snacks'} %}
        {% for cat in categories %}
        <div class="menu-section" data-category="{{ cat }}">
            <h2 class="menu-category-title">{{ cat_labels.get(cat, cat|title) }}</h2>
            <div class="menu-grid featured-grid">
                {% for drink in drinks if drink.category == cat %}
                <div class="menu-card" data-name="{{ drink.name }}" data-price="{{ drink.price }}" data-category="{{ drink.category }}" data-img="{{ drink.img.replace('w=96', 'w=400').replace('h=96', 'h=400') }}">
                    <div class="card-image" data-img="{{ drink.img.replace('w=96', 'w=400').replace('h=96', 'h=400') }}">
                        <img src="{{ drink.img.replace('w=96', 'w=400').replace('h=96', 'h=400') }}" alt="{{ drink.name }}" loading="lazy">
                    </div>
                    <div class="card-info">
                        <span class="card-name">{{ drink.name }}</span>
                        <span class="card-price">{{ drink.price }}</span>
                        {% if drink.price_4 is defined and drink.price_4 %}
                        <span class="card-price-tiers">4x {{ drink.price_4 }}{% if drink.price_10 is defined and drink.price_10 %} ¬∑ 10x {{ drink.price_10 }}{% endif %}</span>
                        {% endif %}
                    </div>
                    <button class="card-add-btn" title="Add to basket">+</button>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Swipe View Container -->
    <div class="swipe-container hidden" id="swipe-container">
        <div class="swipe-progress">
            <div class="swipe-progress-bar" id="swipe-progress-bar"></div>
        </div>
        <div class="swipe-stack" id="swipe-stack">
            <!-- Cards injected by JS -->
        </div>
        <div class="swipe-actions" id="swipe-actions">
            <button class="swipe-action-btn swipe-undo" id="swipe-undo" title="Go back">
                <span>‚Ü©</span>
            </button>
            <button class="swipe-action-btn swipe-nope" id="swipe-nope" title="Skip">
                <span>‚úï</span>
            </button>
            <button class="swipe-action-btn swipe-basket-count" id="swipe-basket-count" title="Basket">
                <span>üõí</span>
                <span class="basket-num" id="basket-num">0</span>
            </button>
            <button class="swipe-action-btn swipe-like" id="swipe-like" title="Add to basket">
                <span>‚ô•</span>
            </button>
            <button class="swipe-action-btn swipe-send" id="swipe-send" title="Send drink">
                <span>üéÅ</span>
            </button>
        </div>
        <!-- Done screen -->
        <div class="swipe-done hidden" id="swipe-done">
            <div class="swipe-done-icon">üéâ</div>
            <h2>You've seen it all!</h2>
            <p id="swipe-done-summary"></p>
            <div class="swipe-done-actions">
                <button class="btn btn-secondary" id="swipe-restart">Swipe Again</button>
                <button class="btn btn-primary" id="swipe-view-basket">View Basket</button>
            </div>
        </div>
    </div>

    <!-- Global Basket Overlay (shared across all views) -->
    <div class="basket-overlay hidden" id="basket-overlay">
        <!-- Edit Mode -->
        <div id="basket-edit-mode">
            <div class="basket-overlay-header">
                <h3>My Order</h3>
                <button class="basket-overlay-close" id="basket-overlay-close">‚úï</button>
            </div>
            <div class="basket-overlay-items" id="basket-overlay-items">
                <!-- Items injected by JS -->
            </div>
            <div class="basket-overlay-footer" id="basket-overlay-footer">
                <div class="basket-overlay-total" id="basket-overlay-total"></div>
                <button class="basket-show-bar-btn" id="basket-show-bar-btn">Show at Bar</button>
                <button class="basket-clear-btn" id="basket-clear-btn">Clear All</button>
            </div>
        </div>
        <!-- Bartender View -->
        <div id="basket-bar-mode" class="basket-bar-view hidden">
            <div class="basket-bar-header">
                <button class="basket-bar-back" id="basket-bar-back">Back</button>
                <div class="basket-bar-table" id="basket-bar-table"></div>
            </div>
            <div class="basket-bar-items" id="basket-bar-items">
                <!-- Large readable items injected by JS -->
            </div>
            <div class="basket-bar-footer">
                <div class="basket-bar-total" id="basket-bar-total"></div>
                <button class="basket-bar-done" id="basket-bar-done">Done ‚Äî Order Placed</button>
            </div>
        </div>
    </div>

    <!-- Floating Basket Button (visible in non-swipe views) -->
    <button class="floating-basket-btn hidden" id="floating-basket-btn">
        <span id="floating-basket-text">üõí Basket</span>
        <span class="floating-basket-num" id="floating-basket-num">0</span>
    </button>

    <!-- Bottom navigation -->
    <nav class="bottom-nav">
        <a href="/menu" class="nav-item active">
            <span class="nav-icon">üìã</span>
            <span>Menu</span>
        </a>
        <a href="/tables" class="nav-item">
            <span class="nav-icon">ü™ë</span>
            <span>Tables</span>
        </a>
    </nav>
</div>

<script>
    // ===== View toggle functionality =====
    const viewBtns = document.querySelectorAll('.view-btn');
    const menuContent = document.getElementById('menu-content');
    const menuPage = document.querySelector('.menu-page');
    const swipeContainer = document.getElementById('swipe-container');

    // Attach click handlers FIRST so buttons always work
    viewBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            const view = btn.dataset.view;
            setView(view);
            localStorage.setItem('menuView', view);
        });
    });

    // Then restore saved view (wrapped in try-catch for safety)
    try {
        const savedView = localStorage.getItem('menuView') || 'featured';
        setView(savedView);
    } catch (e) {
        console.error('Failed to restore view:', e);
        setView('featured');
    }

    function setView(view) {
        viewBtns.forEach(b => b.classList.remove('active'));
        const btn = document.querySelector(`[data-view="${view}"]`);
        if (btn) btn.classList.add('active');

        menuContent.className = 'menu-content';
        menuContent.classList.add(`view-${view}`);

        const floatingBtn = document.getElementById('floating-basket-btn');

        // Toggle swipe mode
        if (view === 'swipe') {
            menuPage.classList.add('view-swipe');
            swipeContainer.classList.remove('hidden');
            floatingBtn.classList.add('hidden');
            initSwipe();
        } else {
            menuPage.classList.remove('view-swipe');
            swipeContainer.classList.add('hidden');
            floatingBtn.classList.remove('hidden');
        }
    }

    // ===== Category filter functionality =====
    const tabs = document.querySelectorAll('.category-tab');
    const sections = document.querySelectorAll('.menu-section');

    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');

            const category = tab.dataset.category;
            sections.forEach(section => {
                if (category === 'all' || section.dataset.category === category) {
                    section.classList.remove('hidden');
                } else {
                    section.classList.add('hidden');
                }
            });
        });
    });

    // ===== Basket (localStorage-backed, qty-grouped) =====
    let basket = JSON.parse(localStorage.getItem('shamrockBasket') || '[]');
    function saveBasket() { localStorage.setItem('shamrockBasket', JSON.stringify(basket)); }
    function addToBasket(item) {
        const existing = basket.find(b => b.name === item.name);
        if (existing) { existing.qty = (existing.qty || 1) + 1; }
        else { basket.push({ name: item.name, price: item.price, category: item.category, img: item.img || '', qty: 1 }); }
        saveBasket();
        updateBasketUI();
        // Pulse the floating button
        const fbtn = document.getElementById('floating-basket-btn');
        fbtn.classList.remove('basket-pulse');
        void fbtn.offsetWidth; // force reflow
        fbtn.classList.add('basket-pulse');
    }
    function changeQty(index, delta) {
        if (!basket[index]) return;
        basket[index].qty = (basket[index].qty || 1) + delta;
        if (basket[index].qty <= 0) basket.splice(index, 1);
        saveBasket();
    }
    function getBasketTotal() {
        return basket.reduce(function(sum, item) {
            var num = parseFloat(item.price.replace(/[^0-9.]/g, ''));
            return sum + (isNaN(num) ? 0 : num) * (item.qty || 1);
        }, 0);
    }
    function getBasketQty() {
        return basket.reduce(function(sum, item) { return sum + (item.qty || 1); }, 0);
    }
    function updateBasketUI() {
        var qty = getBasketQty();
        var total = getBasketTotal();
        document.getElementById('basket-num').textContent = qty;
        document.getElementById('floating-basket-num').textContent = qty;
        var textEl = document.getElementById('floating-basket-text');
        if (qty > 0) {
            textEl.textContent = 'üõí ' + qty + (qty === 1 ? ' item' : ' items') + ' ¬∑ ' + total.toFixed(0) + ' z≈Ç';
            document.getElementById('floating-basket-btn').classList.remove('hidden');
        } else {
            textEl.textContent = 'üõí Basket';
        }
    }
    // Init basket UI on load
    updateBasketUI();

    // ===== Swipe (Tinder) Mode =====
    const swipeHistory = []; // tracks {index, addedToBasket} for undo
    let swipeItems = [];
    let currentIndex = 0;
    let swipeInitialized = false;

    // Category name mapping
    const categoryNames = {
        beers: 'Beer & Cider',
        cocktails: 'Cocktails',
        whiskey: 'Whiskey',
        softdrinks: 'Softdrinks',
        snacks: 'Snacks'
    };

    function extractMenuItems() {
        const items = [];
        document.querySelectorAll('.menu-section[data-category]').forEach(section => {
            const cat = section.dataset.category;
            section.querySelectorAll('.menu-card').forEach(card => {
                const nameEl = card.querySelector('.card-name');
                const priceEl = card.querySelector('.card-price');
                const tiersEl = card.querySelector('.card-price-tiers');
                const descEl = card.querySelector('.card-desc');
                const badgeEl = card.querySelector('.card-badge');
                const imageEl = card.querySelector('.card-image');
                if (!nameEl || !priceEl) return;

                // Get the gradient class
                let gradientClass = '';
                if (imageEl) {
                    imageEl.classList.forEach(cls => {
                        if (cls.endsWith('-gradient')) gradientClass = cls;
                    });
                }

                // Get image URL from data-img attribute
                let imgUrl = '';
                if (imageEl) {
                    imgUrl = imageEl.dataset.img || '';
                }

                items.push({
                    name: nameEl.textContent.trim(),
                    price: priceEl.textContent.trim(),
                    tiers: tiersEl ? tiersEl.textContent.trim() : '',
                    desc: descEl ? descEl.textContent.trim() : '',
                    badge: badgeEl ? badgeEl.textContent.trim() : '',
                    img: imgUrl,
                    gradient: gradientClass,
                    category: cat
                });
            });
        });
        // Also extract featured banner item
        const banner = document.querySelector('.featured-banner');
        if (banner) {
            const cat = banner.dataset.category;
            const title = banner.querySelector('.banner-title');
            const price = banner.querySelector('.banner-price');
            const desc = banner.querySelector('.banner-desc');
            const badge = banner.querySelector('.banner-badge');
            const visual = banner.querySelector('.banner-visual');
            if (title && price) {
                let gradientClass = '';
                if (visual) {
                    visual.classList.forEach(cls => {
                        if (cls.endsWith('-gradient')) gradientClass = cls;
                    });
                }
                // Get image from banner visual's img tag
                const bannerImg = visual ? visual.querySelector('img') : null;
                const bannerImgUrl = bannerImg ? bannerImg.src.replace('w=300', 'w=400').replace('h=300', 'h=400') : '';
                items.unshift({
                    name: title.textContent.trim(),
                    price: price.textContent.trim(),
                    desc: desc ? desc.textContent.trim() : '',
                    badge: badge ? badge.textContent.trim() : '',
                    img: bannerImgUrl,
                    gradient: gradientClass,
                    category: cat
                });
            }
        }
        return items;
    }

    function shuffleArray(arr) {
        for (let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
    }

    function initSwipe() {
        if (swipeInitialized) return;
        swipeInitialized = true;
        swipeItems = shuffleArray(extractMenuItems());
        currentIndex = 0;
        updateBasketUI();
        renderCards();

        // Button handlers
        document.getElementById('swipe-nope').addEventListener('click', () => swipeAction('left'));
        document.getElementById('swipe-like').addEventListener('click', () => swipeAction('right'));
        document.getElementById('swipe-undo').addEventListener('click', undoSwipe);
        document.getElementById('swipe-send').addEventListener('click', sendCurrentDrink);
        document.getElementById('swipe-basket-count').addEventListener('click', showBasket);
        document.getElementById('swipe-restart').addEventListener('click', restartSwipe);
        document.getElementById('swipe-view-basket').addEventListener('click', showBasket);
    }

    function renderCards() {
        const stack = document.getElementById('swipe-stack');
        const done = document.getElementById('swipe-done');
        stack.innerHTML = '';

        if (currentIndex >= swipeItems.length) {
            // Show done screen
            done.classList.remove('hidden');
            document.querySelector('.swipe-actions').classList.add('hidden');
            const bqty = getBasketQty();
            document.getElementById('swipe-done-summary').textContent =
                `You added ${bqty} item${bqty !== 1 ? 's' : ''} to your basket.`;
            updateProgress();
            return;
        }

        done.classList.add('hidden');
        document.querySelector('.swipe-actions').classList.remove('hidden');

        // Render up to 3 cards
        const count = Math.min(3, swipeItems.length - currentIndex);
        for (let i = count - 1; i >= 0; i--) {
            const item = swipeItems[currentIndex + i];
            const card = createSwipeCard(item);
            stack.appendChild(card);
        }

        // Attach drag to top card
        const topCard = stack.querySelector('.swipe-card:first-child');
        if (topCard) attachDrag(topCard);

        updateProgress();
    }

    function createSwipeCard(item) {
        const card = document.createElement('div');
        card.className = 'swipe-card';
        // Use larger image for full-bleed card
        const bigImg = item.img ? item.img.replace('w=400', 'w=800').replace('h=400', 'h=800').replace('w=96', 'w=800').replace('h=96', 'h=800') : '';
        card.innerHTML = `
            ${bigImg ? `<img class="swipe-card-bg" src="${bigImg}" alt="${item.name}" loading="lazy" draggable="false">` : `<div class="swipe-card-bg-fallback ${item.gradient}"></div>`}
            <div class="swipe-overlay swipe-overlay-add">
                <span class="swipe-overlay-label">ADD</span>
            </div>
            <div class="swipe-overlay swipe-overlay-nope">
                <span class="swipe-overlay-label">NOPE</span>
            </div>
            <div class="swipe-card-info">
                <div class="swipe-card-category">${categoryNames[item.category] || item.category}</div>
                <div class="swipe-card-name">${item.name}</div>
                ${item.desc ? `<div class="swipe-card-desc">${item.desc}</div>` : ''}
                <div class="swipe-card-price">${item.price}</div>
                ${item.tiers ? `<div class="swipe-card-tiers">${item.tiers}</div>` : ''}
                ${item.badge ? `<span class="swipe-card-badge">${item.badge}</span>` : ''}
            </div>
        `;
        return card;
    }

    function updateProgress() {
        const pct = swipeItems.length > 0
            ? (currentIndex / swipeItems.length) * 100
            : 0;
        document.getElementById('swipe-progress-bar').style.width = pct + '%';
    }


    // ===== Drag / Swipe handling =====
    // Track document-level listeners so we can clean them up
    let activeDocListeners = null;

    function cleanupDocListeners() {
        if (activeDocListeners) {
            document.removeEventListener('mousemove', activeDocListeners.move);
            document.removeEventListener('mouseup', activeDocListeners.end);
            activeDocListeners = null;
        }
    }

    function attachDrag(card) {
        let startX = 0, startY = 0, currentX = 0, isDragging = false;
        let rafId = null;
        let locked = false; // true once we know it's a horizontal swipe
        const addOverlay = card.querySelector('.swipe-overlay-add');
        const nopeOverlay = card.querySelector('.swipe-overlay-nope');

        function onStart(e) {
            isDragging = true;
            locked = false;
            const point = e.touches ? e.touches[0] : e;
            startX = point.clientX;
            startY = point.clientY;
            card.style.transition = 'none';
            card.style.willChange = 'transform, opacity';
        }

        function onMove(e) {
            if (!isDragging) return;
            const point = e.touches ? e.touches[0] : e;
            const dx = point.clientX - startX;
            const dy = point.clientY - startY;

            // Lock direction on first significant move
            if (!locked) {
                if (Math.abs(dx) < 5 && Math.abs(dy) < 5) return;
                if (Math.abs(dy) > Math.abs(dx)) {
                    // Vertical scroll - cancel the swipe
                    isDragging = false;
                    return;
                }
                locked = true;
            }

            // Prevent page scroll during horizontal swipe
            if (e.cancelable) e.preventDefault();

            currentX = dx;

            // Use requestAnimationFrame for smooth rendering
            if (rafId) cancelAnimationFrame(rafId);
            rafId = requestAnimationFrame(() => {
                const rotate = currentX * 0.1;
                card.style.transform = `translateX(${currentX}px) rotate(${rotate}deg)`;

                const threshold = 80;
                if (currentX > 0) {
                    addOverlay.style.opacity = Math.min(currentX / threshold, 1);
                    nopeOverlay.style.opacity = 0;
                } else {
                    nopeOverlay.style.opacity = Math.min(Math.abs(currentX) / threshold, 1);
                    addOverlay.style.opacity = 0;
                }
            });
        }

        function onEnd() {
            if (!isDragging) return;
            isDragging = false;
            if (rafId) { cancelAnimationFrame(rafId); rafId = null; }
            card.style.willChange = '';

            const threshold = 100;
            if (currentX > threshold) {
                flyOut('right');
            } else if (currentX < -threshold) {
                flyOut('left');
            } else {
                // Snap back
                card.style.transition = 'transform 0.3s cubic-bezier(.2,.8,.3,1)';
                card.style.transform = 'translateX(0) rotate(0deg)';
                addOverlay.style.opacity = 0;
                nopeOverlay.style.opacity = 0;
            }
            currentX = 0;
        }

        function flyOut(direction) {
            const flyX = direction === 'right' ? window.innerWidth : -window.innerWidth;
            const rotate = direction === 'right' ? 30 : -30;
            card.style.transition = 'transform 0.35s cubic-bezier(.2,.8,.3,1), opacity 0.35s ease';
            card.style.transform = `translateX(${flyX}px) rotate(${rotate}deg)`;
            card.style.opacity = '0';

            const addedToBasket = direction === 'right';
            if (addedToBasket) {
                addToBasket(swipeItems[currentIndex]);
            }

            swipeHistory.push({ index: currentIndex, addedToBasket });
            currentIndex++;
            setTimeout(renderCards, 300);
        }

        // Touch events - passive: false so we can preventDefault on horizontal swipe
        card.addEventListener('touchstart', onStart, { passive: true });
        card.addEventListener('touchmove', onMove, { passive: false });
        card.addEventListener('touchend', onEnd);
        card.addEventListener('touchcancel', onEnd);

        // Mouse events - clean up old listeners before adding new ones
        cleanupDocListeners();
        card.addEventListener('mousedown', onStart);
        activeDocListeners = { move: onMove, end: onEnd };
        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', onEnd);
    }

    function swipeAction(direction) {
        const stack = document.getElementById('swipe-stack');
        const topCard = stack.querySelector('.swipe-card:first-child');
        if (!topCard || currentIndex >= swipeItems.length) return;

        const flyX = direction === 'right' ? window.innerWidth : -window.innerWidth;
        const rotate = direction === 'right' ? 30 : -30;
        const overlay = direction === 'right'
            ? topCard.querySelector('.swipe-overlay-add')
            : topCard.querySelector('.swipe-overlay-nope');

        if (overlay) overlay.style.opacity = '1';

        topCard.style.transition = 'transform 0.4s ease, opacity 0.4s ease';
        topCard.style.transform = `translateX(${flyX}px) rotate(${rotate}deg)`;
        topCard.style.opacity = '0';

        const addedToBasket = direction === 'right';
        if (addedToBasket) {
            addToBasket(swipeItems[currentIndex]);
        }

        swipeHistory.push({ index: currentIndex, addedToBasket });
        currentIndex++;
        setTimeout(renderCards, 350);
    }

    function undoSwipe() {
        if (swipeHistory.length === 0) return;
        const last = swipeHistory.pop();

        // Remove from basket if it was added (reverse of addToBasket)
        if (last.addedToBasket) {
            const itemName = swipeItems[last.index].name;
            const idx = basket.findIndex(b => b.name === itemName);
            if (idx !== -1) {
                basket[idx].qty = (basket[idx].qty || 1) - 1;
                if (basket[idx].qty <= 0) basket.splice(idx, 1);
                saveBasket();
                updateBasketUI();
            }
        }

        currentIndex = last.index;
        renderCards();
    }

    function sendCurrentDrink() {
        if (currentIndex >= swipeItems.length) return;
        const item = swipeItems[currentIndex];

        // Check if user has a table
        const myTable = localStorage.getItem('shamrockTable');
        if (!myTable) {
            // Not checked in ‚Äî go to home to pick a table first
            localStorage.setItem('shamrockSendDrink', JSON.stringify(item));
            window.location.href = '/';
            return;
        }

        // Save drink to localStorage and navigate to tables
        localStorage.setItem('shamrockSendDrink', JSON.stringify(item));
        window.location.href = '/tables';
    }

    // ===== Basket =====
    function showBasket() {
        const overlay = document.getElementById('basket-overlay');
        const editMode = document.getElementById('basket-edit-mode');
        const barMode = document.getElementById('basket-bar-mode');
        const itemsEl = document.getElementById('basket-overlay-items');
        const totalEl = document.getElementById('basket-overlay-total');
        const footer = document.getElementById('basket-overlay-footer');

        // Always show edit mode first
        editMode.style.display = '';
        barMode.classList.add('hidden');
        overlay.classList.remove('hidden');

        if (basket.length === 0) {
            itemsEl.innerHTML = '<div class="basket-overlay-empty">Your order is empty.<br>Tap + to add items!</div>';
            footer.classList.add('hidden');
            return;
        }

        footer.classList.remove('hidden');

        itemsEl.innerHTML = basket.map((item, i) => {
            const unitPrice = parseFloat(item.price.replace(/[^0-9.]/g, ''));
            const lineTotal = isNaN(unitPrice) ? '' : (unitPrice * (item.qty || 1)).toFixed(0) + ' z≈Ç';
            const thumbUrl = item.img ? item.img.replace('w=400', 'w=96').replace('h=400', 'h=96').replace('w=800', 'w=96').replace('h=800', 'h=96') : '';
            return `
            <div class="basket-overlay-item">
                <div class="basket-overlay-item-img">${thumbUrl ? `<img src="${thumbUrl}" alt="${item.name}">` : ''}</div>
                <div class="basket-overlay-item-info">
                    <div class="basket-overlay-item-name">${item.name}</div>
                    <div class="basket-overlay-item-cat">${categoryNames[item.category] || item.category}</div>
                </div>
                <div class="basket-qty-controls">
                    <button class="basket-qty-btn" data-index="${i}" data-delta="-1">‚àí</button>
                    <span class="basket-qty-num">${item.qty || 1}</span>
                    <button class="basket-qty-btn" data-index="${i}" data-delta="1">+</button>
                </div>
                <div class="basket-overlay-item-price">${lineTotal}</div>
            </div>`;
        }).join('');

        // Qty control buttons
        itemsEl.querySelectorAll('.basket-qty-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const idx = parseInt(btn.dataset.index);
                const delta = parseInt(btn.dataset.delta);
                changeQty(idx, delta);
                updateBasketUI();
                showBasket(); // Re-render
            });
        });

        // Total
        totalEl.textContent = `Total: ${getBasketTotal().toFixed(0)} z≈Ç`;
    }

    function hideBasket() {
        document.getElementById('basket-overlay').classList.add('hidden');
        releaseWakeLock();
    }

    // ===== Bartender View =====
    let wakeLock = null;

    async function acquireWakeLock() {
        try {
            if ('wakeLock' in navigator) {
                wakeLock = await navigator.wakeLock.request('screen');
            }
        } catch (e) { /* ignore */ }
    }

    function releaseWakeLock() {
        if (wakeLock) { wakeLock.release(); wakeLock = null; }
    }

    function showBarView() {
        const editMode = document.getElementById('basket-edit-mode');
        const barMode = document.getElementById('basket-bar-mode');
        const barItemsEl = document.getElementById('basket-bar-items');
        const barTotalEl = document.getElementById('basket-bar-total');
        const barTableEl = document.getElementById('basket-bar-table');

        // Table number
        const tableNum = localStorage.getItem('shamrockTable');
        barTableEl.textContent = tableNum ? 'Table ' + tableNum : '';

        // Build item list
        barItemsEl.innerHTML = basket.map(item => {
            const unitPrice = parseFloat(item.price.replace(/[^0-9.]/g, ''));
            const lineTotal = isNaN(unitPrice) ? item.price : (unitPrice * (item.qty || 1)).toFixed(0) + ' z≈Ç';
            return `
            <div class="basket-bar-item">
                <span class="basket-bar-item-qty">${item.qty || 1}√ó</span>
                <span class="basket-bar-item-name">${item.name}</span>
                <span class="basket-bar-item-price">${lineTotal}</span>
            </div>`;
        }).join('');

        barTotalEl.textContent = getBasketTotal().toFixed(0) + ' z≈Ç';

        // Switch views
        editMode.style.display = 'none';
        barMode.classList.remove('hidden');

        // Keep screen awake
        acquireWakeLock();
    }

    function hideBarView() {
        document.getElementById('basket-edit-mode').style.display = '';
        document.getElementById('basket-bar-mode').classList.add('hidden');
        releaseWakeLock();
    }

    function clearBasket() {
        basket = [];
        saveBasket();
        updateBasketUI();
    }

    // Wire up basket buttons
    document.getElementById('basket-show-bar-btn').addEventListener('click', showBarView);
    document.getElementById('basket-clear-btn').addEventListener('click', () => {
        if (confirm('Clear your entire order?')) {
            clearBasket();
            showBasket();
        }
    });
    document.getElementById('basket-bar-back').addEventListener('click', hideBarView);
    document.getElementById('basket-bar-done').addEventListener('click', () => {
        clearBasket();
        hideBasket();
        // Brief confirmation toast
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = 'toast toast-info';
        toast.textContent = 'Enjoy your drinks! üçª';
        container.appendChild(toast);
        setTimeout(() => { toast.classList.add('fade-out'); setTimeout(() => toast.remove(), 300); }, 3000);
    });

    function restartSwipe() {
        swipeItems = shuffleArray(extractMenuItems());
        currentIndex = 0;
        swipeHistory.length = 0;
        updateBasketUI();
        document.getElementById('swipe-done').classList.add('hidden');
        document.querySelector('.swipe-actions').classList.remove('hidden');
        hideBasket();
        renderCards();
    }

    // ===== Card Add-to-Basket buttons (featured/grid/list views) =====
    document.querySelectorAll('.menu-card .card-add-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const card = btn.closest('.menu-card');
            addToBasket({
                name: card.dataset.name,
                price: card.dataset.price,
                category: card.dataset.category,
                img: card.dataset.img || '',
            });

            // Brief visual feedback
            btn.classList.add('added');
            btn.textContent = '‚úì';
            setTimeout(() => {
                btn.classList.remove('added');
                btn.textContent = '+';
            }, 800);
        });
    });

    // Floating basket button
    document.getElementById('floating-basket-btn').addEventListener('click', showBasket);

    // Global basket close button
    document.getElementById('basket-overlay-close').addEventListener('click', hideBasket);

    // ===== Cross-page notifications (while browsing menu) =====
    (function() {
        const myTable = parseInt(localStorage.getItem('shamrockTable'));
        const sessionId = localStorage.getItem('shamrockSession');
        if (!myTable || !sessionId) return; // Not checked in, skip

        // Request notification permission if needed (iOS needs user gesture)
        if ('Notification' in window && Notification.permission === 'default') {
            const container = document.getElementById('toast-container');
            const banner = document.createElement('div');
            banner.className = 'toast toast-info';
            banner.style.cursor = 'pointer';
            banner.textContent = 'Tap to enable drink notifications';
            banner.addEventListener('click', () => {
                Notification.requestPermission().then((perm) => {
                    banner.remove();
                    if (perm === 'granted') {
                        navigator.serviceWorker.ready.then(reg => {
                            reg.showNotification('Shamrock', { body: 'Notifications enabled! üéâ', icon: '/static/icon-192.png' });
                        });
                    }
                });
            });
            container.appendChild(banner);
            setTimeout(() => { banner.classList.add('fade-out'); setTimeout(() => banner.remove(), 300); }, 8000);
        }

        const socket = io();

        socket.on('connect', () => {
            socket.emit('rejoin_table', {
                table_number: myTable,
                session_id: sessionId
            });
        });

        socket.on('rejoin_failed', () => {
            localStorage.removeItem('shamrockTable');
            localStorage.removeItem('shamrockSession');
            localStorage.removeItem('shamrockProfileName');
            localStorage.removeItem('shamrockProfilePhoto');
            window.location.href = '/';
        });

        function sendMenuNotification(title, body) {
            if ('Notification' in window && Notification.permission === 'granted') {
                if (navigator.serviceWorker && navigator.serviceWorker.controller) {
                    navigator.serviceWorker.ready.then(reg => {
                        reg.showNotification(title, { body, icon: '/static/icon-192.png' });
                    });
                } else {
                    const n = new Notification(title, { body, icon: '/static/icon-192.png' });
                    n.onclick = () => { window.focus(); n.close(); };
                    setTimeout(() => n.close(), 8000);
                }
            }
        }

        socket.on('incoming_message', (data) => {
            const sender = data.from_name || `Table ${data.from_table}`;
            const noteText = data.note ? ` ‚Äî "${data.note}"` : '';
            const msg = `${sender} wants to buy you a ${data.content}!${noteText}`;
            sendMenuNotification('Incoming Drink! üç∫', msg);
            showMenuToast(msg, '/tables');
        });

        socket.on('message_response', (data) => {
            const table = data.responder_table ? (data.responder_name || `Table ${data.responder_table}`) : 'They';
            const drink = data.content || 'your drink';
            const msg = data.type === 'accepted'
                ? `${table} accepted your ${drink}! ü•Ç`
                : `${table} declined your ${drink}`;

            if (document.hidden) {
                sendMenuNotification(
                    data.type === 'accepted' ? 'Drink Accepted! ü•Ç' : 'Drink Declined',
                    msg
                );
            }
            showMenuToast(msg);
        });

        function showMenuToast(message, link) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast toast-info';
            if (link) {
                toast.style.cursor = 'pointer';
                toast.textContent = message + ' Tap to respond ‚Üí';
                toast.addEventListener('click', () => { window.location.href = link; });
            } else {
                toast.textContent = message;
            }
            container.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('fade-out');
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }
    })();
</script>
{% endblock %}
