{% extends "base.html" %}

{% block title %}People{% endblock %}

{% block content %}
<div class="people-page">
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <span class="your-name" id="my-name">-</span>
        </div>
        <button id="checkout-btn" class="btn btn-small btn-outline">Check Out</button>
    </header>

    <!-- Notification permission banner -->
    <div id="notif-banner" class="notif-banner hidden">
        <span>Enable notifications to know when you get a drink</span>
        <button id="notif-enable-btn" class="btn btn-small btn-primary">Enable</button>
        <button id="notif-dismiss-btn" class="notif-dismiss">&times;</button>
    </div>

    <!-- Connection status -->
    <div id="connection-status" class="connection-status hidden">
        Reconnecting...
    </div>

    <!-- People grid -->
    <div class="people-grid-container">
        <h2>Tap someone to connect</h2>
        <div id="people-grid" class="people-grid">
            <!-- People rendered here by JS -->
        </div>
        <p id="empty-state" class="empty-state hidden">
            You're the first one here! üéâ<br>Others will appear when they join.
        </p>
    </div>

    <!-- Action Modal -->
    <div id="action-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3><span id="target-name">-</span></h3>
                <p id="target-instagram" class="target-instagram hidden"></p>
                <button class="modal-close">&times;</button>
            </div>
            <!-- Action buttons -->
            <div id="action-step" class="action-step">
                <button id="buy-drink-btn" class="buy-drink-btn">
                    <span class="buy-drink-icon">üç∫</span>
                    <span>Buy a Drink</span>
                </button>
                <div class="game-row">
                    <button id="rps-btn" class="rps-btn">
                        <span class="rps-btn-icon">‚úä</span>
                        <span>Rock Paper Scissors</span>
                    </button>
                    <button class="how-to-play-btn" data-game="rps" title="How to play">?</button>
                </div>
                <div class="game-row">
                    <button id="bomb-btn" class="bomb-btn">
                        <span class="bomb-btn-icon">üí£</span>
                        <span>Bomb Pass</span>
                    </button>
                    <button class="how-to-play-btn" data-game="bomb" title="How to play">?</button>
                </div>
                <div class="game-row">
                    <button id="tap-btn" class="tap-btn">
                        <span class="tap-btn-icon">üëÜ</span>
                        <span>Tap Race</span>
                    </button>
                    <button class="how-to-play-btn" data-game="tap" title="How to play">?</button>
                </div>
                <div class="game-row">
                    <button id="ttol-btn" class="ttol-btn">
                        <span class="ttol-btn-icon">ü§•</span>
                        <span>2 Truths 1 Lie</span>
                    </button>
                    <button class="how-to-play-btn" data-game="ttol" title="How to play">?</button>
                </div>
            </div>
            <!-- TTOL Setup Step -->
            <div id="ttol-setup-step" class="rps-setup-step hidden">
                <p class="rps-setup-label">Choose game mode</p>
                <div class="rps-mode-buttons">
                    <button class="ttol-mode-btn" data-mode="fun">
                        <span class="rps-mode-icon">üéÆ</span>
                        <span>Just for Fun</span>
                    </button>
                    <button class="ttol-mode-btn" data-mode="drink">
                        <span class="rps-mode-icon">üç∫</span>
                        <span>Play for a Drink</span>
                    </button>
                </div>
            </div>
            <!-- Tap Race Setup Step -->
            <div id="tap-setup-step" class="rps-setup-step hidden">
                <p class="rps-setup-label">Choose game mode</p>
                <div class="rps-mode-buttons">
                    <button class="tap-mode-btn" data-mode="fun">
                        <span class="rps-mode-icon">üéÆ</span>
                        <span>Just for Fun</span>
                    </button>
                    <button class="tap-mode-btn" data-mode="drink">
                        <span class="rps-mode-icon">üç∫</span>
                        <span>Play for a Drink</span>
                    </button>
                </div>
            </div>
            <!-- Bomb Setup Step -->
            <div id="bomb-setup-step" class="rps-setup-step hidden">
                <p class="rps-setup-label">Choose game mode</p>
                <div class="rps-mode-buttons">
                    <button class="bomb-mode-btn" data-mode="fun">
                        <span class="rps-mode-icon">üéÆ</span>
                        <span>Just for Fun</span>
                    </button>
                    <button class="bomb-mode-btn" data-mode="drink">
                        <span class="rps-mode-icon">üç∫</span>
                        <span>Play for a Drink</span>
                    </button>
                </div>
            </div>
            <!-- RPS Setup Step -->
            <div id="rps-setup-step" class="rps-setup-step hidden">
                <p class="rps-setup-label">Choose game mode</p>
                <div class="rps-mode-buttons">
                    <button class="rps-mode-btn" data-mode="fun">
                        <span class="rps-mode-icon">üéÆ</span>
                        <span>Just for Fun</span>
                    </button>
                    <button class="rps-mode-btn" data-mode="drink">
                        <span class="rps-mode-icon">üç∫</span>
                        <span>Play for a Drink</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Incoming drink notification -->
    <div id="incoming-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content incoming-notification">
            <img id="incoming-photo" class="incoming-photo hidden" src="" alt="">
            <div class="incoming-icon" id="incoming-icon">üç∫</div>
            <p id="incoming-message">Someone wants to buy you a drink!</p>
            <p id="incoming-note" class="incoming-note">Meet at the bar table to get your drink!</p>
            <p id="incoming-queue-count" class="incoming-queue-count hidden"></p>
            <div class="incoming-buttons">
                <button id="decline-btn" class="btn btn-secondary">Decline ‚úó</button>
                <button id="accept-btn" class="btn btn-primary">Accept ‚úì</button>
            </div>
        </div>
    </div>

    <!-- RPS Challenge Incoming -->
    <div id="rps-incoming-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content incoming-notification">
            <img id="rps-incoming-photo" class="incoming-photo hidden" src="" alt="">
            <div class="incoming-icon">‚úä</div>
            <p id="rps-incoming-message">Someone challenges you!</p>
            <p id="rps-incoming-detail" class="incoming-note"></p>
            <div class="incoming-buttons">
                <button id="rps-decline-btn" class="btn btn-secondary">Decline</button>
                <button id="rps-accept-btn" class="btn btn-primary">Accept</button>
            </div>
        </div>
    </div>

    <!-- RPS Game Screen -->
    <div id="rps-game-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content rps-game-content">
            <p class="rps-game-vs" id="rps-game-vs">vs Someone</p>
            <p class="rps-game-mode" id="rps-game-mode"></p>
            <div id="rps-choice-section" class="rps-choices">
                <button class="rps-choice-btn" data-choice="rock">
                    <span>‚úä</span>
                    <span class="rps-choice-label">Rock</span>
                </button>
                <button class="rps-choice-btn" data-choice="paper">
                    <span>‚úã</span>
                    <span class="rps-choice-label">Paper</span>
                </button>
                <button class="rps-choice-btn" data-choice="scissors">
                    <span>‚úåÔ∏è</span>
                    <span class="rps-choice-label">Scissors</span>
                </button>
            </div>
            <div id="rps-waiting" class="rps-waiting hidden">
                <div class="rps-waiting-icon">‚è≥</div>
                <p>Waiting for opponent...</p>
            </div>
        </div>
    </div>

    <!-- RPS Result Screen -->
    <div id="rps-result-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content rps-result-content">
            <button id="rps-result-close" class="modal-close-x">&times;</button>
            <div id="rps-result-icon" class="rps-result-icon">üéâ</div>
            <h3 id="rps-result-title" class="rps-result-title">You won!</h3>
            <div id="rps-result-choices" class="rps-result-choices">
                <div class="rps-result-player">
                    <span class="rps-result-label">You</span>
                    <span id="rps-result-yours" class="rps-result-emoji">‚úä</span>
                </div>
                <span class="rps-result-vs">vs</span>
                <div class="rps-result-player">
                    <span class="rps-result-label" id="rps-result-them-label">Them</span>
                    <span id="rps-result-theirs" class="rps-result-emoji">‚úåÔ∏è</span>
                </div>
            </div>
            <p id="rps-result-drink" class="rps-result-drink hidden"></p>
        </div>
    </div>

    <!-- Bomb Challenge Incoming -->
    <div id="bomb-incoming-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content incoming-notification">
            <img id="bomb-incoming-photo" class="incoming-photo hidden" src="" alt="">
            <div class="incoming-icon">üí£</div>
            <p id="bomb-incoming-message">Someone challenges you!</p>
            <p id="bomb-incoming-detail" class="incoming-note"></p>
            <div class="incoming-buttons">
                <button id="bomb-decline-btn" class="btn btn-secondary">Decline</button>
                <button id="bomb-accept-btn" class="btn btn-primary">Accept</button>
            </div>
        </div>
    </div>

    <!-- Bomb Game Screen -->
    <div id="bomb-game-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content bomb-game-content">
            <p class="rps-game-mode" id="bomb-game-mode"></p>
            <div class="bomb-fuse-bar-track">
                <div id="bomb-fuse-bar" class="bomb-fuse-bar"></div>
            </div>
            <div id="bomb-arena" class="bomb-arena">
                <div class="bomb-player bomb-player-you" id="bomb-player-you">
                    <div class="bomb-player-avatar">üôÇ</div>
                    <span class="bomb-player-label">You</span>
                </div>
                <div class="bomb-flight-zone">
                    <div id="bomb-emoji" class="bomb-emoji">üí£</div>
                </div>
                <div class="bomb-player bomb-player-them" id="bomb-player-them">
                    <div class="bomb-player-avatar">üôÇ</div>
                    <span class="bomb-player-label" id="bomb-them-label">Them</span>
                </div>
            </div>
            <div id="bomb-status-text" class="bomb-status-text">You're holding the bomb!</div>
            <button id="bomb-pass-btn" class="bomb-pass-btn">PASS!</button>
            <div id="bomb-waiting" class="bomb-waiting hidden">
                <p>They're holding it...</p>
            </div>
        </div>
    </div>

    <!-- Bomb Result Screen -->
    <div id="bomb-result-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content rps-result-content">
            <button id="bomb-result-close" class="modal-close-x">&times;</button>
            <div id="bomb-result-icon" class="rps-result-icon">üí•</div>
            <h3 id="bomb-result-title" class="rps-result-title">You survived!</h3>
            <p id="bomb-result-drink" class="rps-result-drink hidden"></p>
        </div>
    </div>

    <!-- Tap Race Challenge Incoming -->
    <div id="tap-incoming-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content incoming-notification">
            <img id="tap-incoming-photo" class="incoming-photo hidden" src="" alt="">
            <div class="incoming-icon">üëÜ</div>
            <p id="tap-incoming-message">Someone challenges you!</p>
            <p id="tap-incoming-detail" class="incoming-note"></p>
            <div class="incoming-buttons">
                <button id="tap-decline-btn" class="btn btn-secondary">Decline</button>
                <button id="tap-accept-btn" class="btn btn-primary">Accept</button>
            </div>
        </div>
    </div>

    <!-- Tap Race Game Screen -->
    <div id="tap-game-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content tap-game-content">
            <p class="rps-game-mode" id="tap-game-mode"></p>
            <div class="tap-progress-track">
                <div id="tap-progress-bar" class="tap-progress-bar"></div>
            </div>
            <div id="tap-countdown" class="tap-countdown hidden">
                <span id="tap-countdown-text" class="tap-countdown-text">3</span>
            </div>
            <div id="tap-arena" class="tap-arena hidden">
                <div class="tap-lanes">
                    <div class="tap-lane tap-lane-you">
                        <div class="tap-lane-header">
                            <span class="tap-lane-label">YOU</span>
                            <span id="tap-count-you" class="tap-count">0</span>
                        </div>
                        <div class="tap-track">
                            <div class="tap-track-fill" id="tap-track-you"></div>
                            <div class="tap-runner" id="tap-runner-you">üèÉ</div>
                        </div>
                    </div>
                    <div class="tap-lane tap-lane-them">
                        <div class="tap-lane-header">
                            <span class="tap-lane-label" id="tap-them-label">THEM</span>
                            <span id="tap-count-them" class="tap-count">0</span>
                        </div>
                        <div class="tap-track">
                            <div class="tap-track-fill" id="tap-track-them"></div>
                            <div class="tap-runner" id="tap-runner-them">üèÉ</div>
                        </div>
                    </div>
                </div>
            </div>
            <button id="tap-tap-btn" class="tap-tap-btn hidden" disabled>TAP!</button>
        </div>
    </div>

    <!-- Tap Race Result Screen -->
    <div id="tap-result-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content rps-result-content">
            <button id="tap-result-close" class="modal-close-x">&times;</button>
            <div id="tap-result-icon" class="rps-result-icon">üèÜ</div>
            <h3 id="tap-result-title" class="rps-result-title">You win!</h3>
            <p id="tap-result-scores" class="tap-result-scores"></p>
            <p id="tap-result-drink" class="rps-result-drink hidden"></p>
        </div>
    </div>

    <!-- TTOL Challenge Incoming -->
    <div id="ttol-incoming-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content incoming-notification">
            <img id="ttol-incoming-photo" class="incoming-photo hidden" src="" alt="">
            <div class="incoming-icon">ü§•</div>
            <p id="ttol-incoming-message">Someone challenges you!</p>
            <p id="ttol-incoming-detail" class="incoming-note"></p>
            <div class="incoming-buttons">
                <button id="ttol-decline-btn" class="btn btn-secondary">Decline</button>
                <button id="ttol-accept-btn" class="btn btn-primary">Accept</button>
            </div>
        </div>
    </div>

    <!-- TTOL Write Phase Screen -->
    <div id="ttol-write-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content ttol-write-content">
            <p class="rps-game-vs" id="ttol-write-vs">vs Someone</p>
            <p class="rps-game-mode" id="ttol-write-mode"></p>
            <p class="ttol-write-instruction">ü§´ Write 2 truths and 1 lie ‚Äî then tap the lie!</p>
            <div class="ttol-timer-bar-track">
                <div id="ttol-write-timer-bar" class="ttol-timer-bar"></div>
            </div>
            <div class="ttol-statements-form">
                <div class="ttol-statement-row" id="ttol-row-0">
                    <span class="ttol-stmt-number">1</span>
                    <input type="text" class="ttol-statement-input" id="ttol-stmt-0" placeholder="e.g. I've visited 10 countries" maxlength="200" autocomplete="off">
                    <button class="ttol-lie-toggle" data-idx="0">‚úì TRUTH</button>
                </div>
                <div class="ttol-statement-row" id="ttol-row-1">
                    <span class="ttol-stmt-number">2</span>
                    <input type="text" class="ttol-statement-input" id="ttol-stmt-1" placeholder="e.g. I can play guitar" maxlength="200" autocomplete="off">
                    <button class="ttol-lie-toggle" data-idx="1">‚úì TRUTH</button>
                </div>
                <div class="ttol-statement-row" id="ttol-row-2">
                    <span class="ttol-stmt-number">3</span>
                    <input type="text" class="ttol-statement-input" id="ttol-stmt-2" placeholder="e.g. I once met a celebrity" maxlength="200" autocomplete="off">
                    <button class="ttol-lie-toggle" data-idx="2">‚úì TRUTH</button>
                </div>
            </div>
            <button id="ttol-submit-btn" class="ttol-submit-btn" disabled>Fill all 3 & mark the lie</button>
            <div id="ttol-write-waiting" class="rps-waiting hidden">
                <div class="rps-waiting-icon">‚è≥</div>
                <p>Waiting for opponent to write...</p>
            </div>
        </div>
    </div>

    <!-- TTOL Guess Phase Screen -->
    <div id="ttol-guess-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content ttol-guess-content">
            <p class="rps-game-vs" id="ttol-guess-vs">Their Statements</p>
            <p class="ttol-guess-instruction">üîç Which one is the <strong>LIE</strong>? Tap to choose!</p>
            <div class="ttol-timer-bar-track">
                <div id="ttol-guess-timer-bar" class="ttol-timer-bar"></div>
            </div>
            <div class="ttol-guess-cards" id="ttol-guess-cards"></div>
            <button id="ttol-guess-btn" class="ttol-guess-submit-btn" disabled>üîí Lock In My Guess</button>
            <div id="ttol-guess-waiting" class="rps-waiting hidden">
                <div class="rps-waiting-icon">‚è≥</div>
                <p>Waiting for opponent to guess...</p>
            </div>
        </div>
    </div>

    <!-- Challenge Waiting Modal -->
    <div id="challenge-waiting-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content incoming-notification">
            <div class="rps-waiting-icon" style="font-size: 2.5rem; margin-bottom: 0.5rem;">‚è≥</div>
            <p id="challenge-waiting-message" style="font-size: 1.1rem; font-weight: 600;">Waiting for response...</p>
            <p id="challenge-waiting-detail" style="color: #888; font-size: 0.9rem; margin-top: 0.25rem;">They'll see your challenge now</p>
            <button id="challenge-waiting-cancel" class="btn btn-secondary" style="margin-top: 1rem;">Cancel</button>
        </div>
    </div>

    <!-- TTOL Result Screen -->
    <div id="ttol-result-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content ttol-result-content">
            <button id="ttol-result-close" class="modal-close-x">&times;</button>
            <div id="ttol-result-icon" class="rps-result-icon">üéâ</div>
            <h3 id="ttol-result-title" class="rps-result-title">You won!</h3>
            <div id="ttol-result-reveal" class="ttol-result-reveal"></div>
            <p id="ttol-result-drink" class="rps-result-drink hidden"></p>
        </div>
    </div>

    <!-- How to Play Modal -->
    <div id="how-to-play-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content" style="max-width: 340px; text-align: left;">
            <button id="how-to-play-close" class="modal-close-x">&times;</button>
            <h3 id="htp-title" style="margin: 0 0 0.75rem; font-size: 1.2rem;"></h3>
            <div id="htp-body" style="font-size: 0.92rem; line-height: 1.5; color: #ccc;"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Check session
    const sessionId = localStorage.getItem('pakybSession');
    if (!sessionId) {
        window.location.href = '/';
    }

    const myName = localStorage.getItem('pakybProfileName') || 'You';
    document.getElementById('my-name').textContent = myName;

    let targetSession = null;

    // Profile cache: session_id -> {name, photo_url, color_frame}
    const userProfiles = {};

    function userName(sessId) {
        const p = userProfiles[sessId];
        return p ? p.name : 'Someone';
    }

    // ===== Browser Notifications =====
    if ('Notification' in window && Notification.permission === 'default') {
        document.getElementById('notif-banner').classList.remove('hidden');
        document.getElementById('notif-enable-btn').addEventListener('click', () => {
            Notification.requestPermission().then((perm) => {
                document.getElementById('notif-banner').classList.add('hidden');
                if (perm === 'granted') {
                    navigator.serviceWorker.ready.then(reg => {
                        reg.showNotification('pak.yourbro', { body: 'Notifications enabled! üéâ', icon: '/static/icon-192.png' });
                    });
                }
            });
        });
        document.getElementById('notif-dismiss-btn').addEventListener('click', () => {
            document.getElementById('notif-banner').classList.add('hidden');
        });
    }

    function sendBrowserNotification(title, body) {
        if ('Notification' in window && Notification.permission === 'granted' && document.hidden) {
            if (navigator.serviceWorker && navigator.serviceWorker.controller) {
                navigator.serviceWorker.ready.then(reg => {
                    reg.showNotification(title, { body, icon: '/static/icon-192.png' });
                });
            } else {
                const n = new Notification(title, { body, icon: '/static/icon-192.png' });
                n.onclick = () => { window.focus(); n.close(); };
                setTimeout(() => n.close(), 8000);
            }
        }
    }

    // ===== Notification Queue =====
    const incomingQueue = [];
    let processingIncoming = false;

    // ===== Socket Connection =====
    const socket = io();

    let hasConnected = false;
    socket.on('connect', () => {
        console.log('Connected to server');
        document.getElementById('connection-status').classList.add('hidden');
        if (!hasConnected) {
            // First connect ‚Äî use go_online to log activity
            socket.emit('go_online', { session_id: sessionId });
            hasConnected = true;
        } else {
            // Reconnect after disconnect ‚Äî use rejoin
            socket.emit('rejoin', { session_id: sessionId });
        }
    });

    socket.on('disconnect', () => {
        document.getElementById('connection-status').classList.remove('hidden');
    });

    socket.on('online_success', () => {
        console.log('Online!');
    });

    socket.on('rejoin_success', () => {
        console.log('Rejoined!');
    });

    socket.on('rejoin_failed', () => {
        localStorage.removeItem('pakybSession');
        localStorage.removeItem('pakybProfileName');
        localStorage.removeItem('pakybProfilePhoto');
        localStorage.removeItem('pakybColorFrame');
        window.location.href = '/';
    });

    socket.on('kicked', () => {
        localStorage.removeItem('pakybSession');
        localStorage.removeItem('pakybProfileName');
        localStorage.removeItem('pakybProfilePhoto');
        localStorage.removeItem('pakybColorFrame');
        window.location.href = '/';
    });

    // ===== Users Update =====
    socket.on('users_update', (users) => {
        renderPeople(users);
    });

    // Fetch initial user list
    fetch(`/api/users?exclude=${sessionId}`)
        .then(res => res.json())
        .then(users => renderPeople(users));

    function renderPeople(users) {
        const grid = document.getElementById('people-grid');
        const emptyState = document.getElementById('empty-state');

        // Update profile cache
        users.forEach(u => {
            userProfiles[u.session_id] = {
                name: u.name,
                photo_url: u.photo_url,
                color_frame: u.color_frame,
                instagram: u.instagram,
            };
        });

        // Filter out ourselves
        const others = users.filter(u => u.session_id !== sessionId);

        if (others.length === 0) {
            emptyState.classList.remove('hidden');
            grid.innerHTML = '';
            return;
        }
        emptyState.classList.add('hidden');

        grid.innerHTML = others.map(u => {
            const fc = u.color_frame ? ` frame-${u.color_frame}` : '';
            let avatarHtml;
            if (u.photo_url) {
                avatarHtml = `<img class="person-avatar${fc}" src="${u.photo_url}" alt="">`;
            } else {
                avatarHtml = `<div class="person-avatar person-avatar-placeholder${fc}">${u.name[0]}</div>`;
            }
            return `
                <div class="person-card" data-session="${u.session_id}">
                    ${avatarHtml}
                    <span class="person-name">${u.name}</span>
                </div>
            `;
        }).join('');

        // Click handlers
        grid.querySelectorAll('.person-card').forEach(card => {
            card.addEventListener('click', () => {
                targetSession = card.dataset.session;
                openActionModal();
            });
        });
    }

    // ===== Message Events =====
    socket.on('send_success', () => {
        showToast('Drink offer sent! üçª', 'success');
    });

    socket.on('send_error', (data) => {
        showToast(data.message, 'error');
    });

    socket.on('incoming_message', (data) => {
        incomingQueue.push(data);
        if (!processingIncoming) {
            showNextIncoming();
        }
    });

    socket.on('message_response', (data) => {
        const who = data.responder_name || 'They';
        if (data.type === 'accepted') {
            showToast(`${who} accepted! Meet them at the bar table ü•Ç`, 'success');
            sendBrowserNotification('Drink Accepted! ü•Ç', `${who} accepted! Meet at the bar table`);
        } else {
            showToast(`${who} declined your drink offer`, 'info');
            sendBrowserNotification('Drink Declined', `${who} declined your drink offer`);
        }
    });

    socket.on('response_confirmed', (data) => {
        if (data.type === 'accepted') {
            showToast('Meet at the bar table to get your drink! ü•Ç', 'success');
        }
    });

    socket.on('admin_broadcast', (data) => {
        showToast(data.message, 'info');
    });

    // ===== Action Modal =====
    function openActionModal() {
        const profile = userProfiles[targetSession];
        document.getElementById('target-name').textContent = profile ? profile.name : 'Someone';

        const igEl = document.getElementById('target-instagram');
        if (profile && profile.instagram) {
            igEl.textContent = '@' + profile.instagram;
            igEl.classList.remove('hidden');
        } else {
            igEl.classList.add('hidden');
        }

        document.getElementById('action-step').classList.remove('hidden');

        document.getElementById('action-modal').classList.remove('hidden');
    }

    function closeActionModal() {
        document.getElementById('rps-setup-step').classList.add('hidden');
        document.getElementById('bomb-setup-step').classList.add('hidden');
        document.getElementById('tap-setup-step').classList.add('hidden');
        document.getElementById('ttol-setup-step').classList.add('hidden');
        document.getElementById('action-modal').classList.add('hidden');
    }

    document.querySelector('.modal-close').addEventListener('click', closeActionModal);
    document.querySelector('#action-modal .modal-backdrop').addEventListener('click', closeActionModal);

    // Buy a Drink -> confirm and send
    document.getElementById('buy-drink-btn').addEventListener('click', () => {
        showConfirm(`Buy a drink for ${userName(targetSession)}?`, () => {
            socket.emit('send_message', {
                to_session: targetSession,
                message_type: 'drink',
                content: 'a drink',
            });
            closeActionModal();
        });
    });

    // ===== Incoming Notification Queue =====
    function showNextIncoming() {
        if (incomingQueue.length === 0) {
            processingIncoming = false;
            return;
        }
        processingIncoming = true;
        const data = incomingQueue[0];

        const incomingPhoto = document.getElementById('incoming-photo');
        incomingPhoto.className = 'incoming-photo hidden';
        if (data.from_photo) {
            incomingPhoto.src = data.from_photo;
            incomingPhoto.classList.remove('hidden');
            const profile = userProfiles[data.from_session];
            const fc = profile ? profile.color_frame : null;
            if (fc) incomingPhoto.classList.add(`frame-${fc}`);
        }
        document.getElementById('incoming-icon').textContent = 'üç∫';
        const senderName = data.from_name || userName(data.from_session);
        document.getElementById('incoming-message').textContent =
            `${senderName} wants to buy you a drink!`;
        document.getElementById('incoming-note').textContent = 'Meet at the bar table to get your drink!';

        const queueCountEl = document.getElementById('incoming-queue-count');
        if (incomingQueue.length > 1) {
            queueCountEl.textContent = `+${incomingQueue.length - 1} more incoming`;
            queueCountEl.classList.remove('hidden');
        } else {
            queueCountEl.classList.add('hidden');
        }

        document.getElementById('incoming-modal').classList.remove('hidden');
        if (navigator.vibrate) navigator.vibrate([200, 100, 200]);

        sendBrowserNotification(
            `${senderName} wants to buy you a drink!`,
            'Meet at the bar table to get your drink!'
        );
    }

    function handleIncomingResponse(response) {
        const current = incomingQueue.shift();
        if (current) {
            socket.emit('respond_message', {
                message_id: current.message_id,
                response: response,
                from_session: current.from_session,
            });
        }
        document.getElementById('incoming-modal').classList.add('hidden');
        if (incomingQueue.length > 0) {
            setTimeout(showNextIncoming, 400);
        } else {
            processingIncoming = false;
        }
    }

    document.getElementById('accept-btn').addEventListener('click', () => handleIncomingResponse('accepted'));
    document.getElementById('decline-btn').addEventListener('click', () => handleIncomingResponse('declined'));

    // ===== Checkout =====
    document.getElementById('checkout-btn').addEventListener('click', () => {
        showConfirm('Leave pak.yourbro?', () => {
            socket.emit('checkout', { session_id: sessionId });
            localStorage.removeItem('pakybSession');
            localStorage.removeItem('pakybProfileName');
            localStorage.removeItem('pakybProfilePhoto');
            localStorage.removeItem('pakybColorFrame');
            window.location.href = '/';
        }, 'Check Out', 'Stay');
    });

    // ===== Confirm Dialog =====
    function showConfirm(message, onConfirm, confirmText = 'Send ‚úì', cancelText = 'Cancel') {
        document.getElementById('confirm-message').textContent = message;
        document.getElementById('confirm-ok').textContent = confirmText;
        document.getElementById('confirm-cancel').textContent = cancelText;
        document.getElementById('confirm-modal').classList.remove('hidden');

        const confirmHandler = () => {
            document.getElementById('confirm-modal').classList.add('hidden');
            onConfirm();
            cleanup();
        };
        const cancelHandler = () => {
            document.getElementById('confirm-modal').classList.add('hidden');
            cleanup();
        };
        const cleanup = () => {
            document.getElementById('confirm-ok').removeEventListener('click', confirmHandler);
            document.getElementById('confirm-cancel').removeEventListener('click', cancelHandler);
        };
        document.getElementById('confirm-ok').addEventListener('click', confirmHandler);
        document.getElementById('confirm-cancel').addEventListener('click', cancelHandler);
    }

    // ===== Toast =====
    function showToast(message, type = 'info') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => {
            toast.classList.add('fade-out');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // ===== Challenge Waiting Modal =====
    let challengeWaitingGameType = null;

    function showChallengeWaiting(targetName, gameLabel) {
        document.getElementById('challenge-waiting-message').textContent =
            `Waiting for ${targetName}...`;
        document.getElementById('challenge-waiting-detail').textContent =
            `${gameLabel} challenge sent`;
        document.getElementById('challenge-waiting-modal').classList.remove('hidden');
        challengeWaitingGameType = gameLabel;
    }

    function hideChallengeWaiting() {
        document.getElementById('challenge-waiting-modal').classList.add('hidden');
        challengeWaitingGameType = null;
    }

    document.getElementById('challenge-waiting-cancel').addEventListener('click', hideChallengeWaiting);

    // ===== Rock Paper Scissors =====
    let rpsGameId = null;
    let rpsOpponentSession = null;
    const choiceEmoji = { rock: '‚úä', paper: '‚úã', scissors: '‚úåÔ∏è' };

    document.getElementById('rps-btn').addEventListener('click', () => {
        document.getElementById('action-step').classList.add('hidden');
        document.getElementById('bomb-setup-step').classList.add('hidden');
        document.getElementById('tap-setup-step').classList.add('hidden');
        document.getElementById('ttol-setup-step').classList.add('hidden');
        document.getElementById('rps-setup-step').classList.remove('hidden');
    });

    document.querySelectorAll('.rps-mode-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const mode = btn.dataset.mode;
            socket.emit('rps_challenge', {
                to_session: targetSession,
                mode: mode,
                drink: mode === 'drink' ? 'drink' : '',
            });
            closeActionModal();
            showChallengeWaiting(userName(targetSession), 'Rock Paper Scissors');
        });
    });

    socket.on('rps_error', (data) => { hideChallengeWaiting(); showToast(data.message, 'error'); });

    socket.on('rps_declined', (data) => {
        hideChallengeWaiting();
        showToast(`${userName(data.from_session)} declined your challenge`, 'info');
    });

    socket.on('rps_incoming', (data) => {
        rpsGameId = data.game_id;
        const modeText = data.mode === 'drink' ? 'Loser buys the winner a drink!' : 'Just for fun!';
        const rpsPhoto = document.getElementById('rps-incoming-photo');
        rpsPhoto.className = 'incoming-photo hidden';
        if (data.from_photo) {
            rpsPhoto.src = data.from_photo;
            rpsPhoto.classList.remove('hidden');
            const profile = userProfiles[data.from_session];
            if (profile && profile.color_frame) rpsPhoto.classList.add(`frame-${profile.color_frame}`);
        }
        const challenger = data.from_name || userName(data.from_session);
        document.getElementById('rps-incoming-message').textContent =
            `${challenger} challenges you to Rock Paper Scissors!`;
        document.getElementById('rps-incoming-detail').textContent = modeText;
        document.getElementById('rps-incoming-modal').classList.remove('hidden');
        if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
        sendBrowserNotification('RPS Challenge!', `${challenger} wants to play! ${modeText}`);
    });

    document.getElementById('rps-accept-btn').addEventListener('click', () => {
        document.getElementById('rps-incoming-modal').classList.add('hidden');
        socket.emit('rps_response', { game_id: rpsGameId, accepted: true });
    });

    document.getElementById('rps-decline-btn').addEventListener('click', () => {
        document.getElementById('rps-incoming-modal').classList.add('hidden');
        socket.emit('rps_response', { game_id: rpsGameId, accepted: false });
        rpsGameId = null;
    });

    socket.on('rps_start', (data) => {
        if (data.session_a !== sessionId && data.session_b !== sessionId) return;
        hideChallengeWaiting();
        rpsGameId = data.game_id;
        rpsOpponentSession = data.session_a === sessionId ? data.session_b : data.session_a;

        document.getElementById('rps-game-vs').textContent = `vs ${userName(rpsOpponentSession)}`;
        const modeText = data.mode === 'drink' ? `Playing for: ${data.drink}` : 'Just for fun';
        document.getElementById('rps-game-mode').textContent = modeText;

        document.getElementById('rps-choice-section').classList.remove('hidden');
        document.getElementById('rps-waiting').classList.add('hidden');
        document.querySelectorAll('.rps-choice-btn').forEach(b => {
            b.classList.remove('selected', 'disabled');
            b.disabled = false;
        });
        document.getElementById('rps-game-modal').classList.remove('hidden');
    });

    document.querySelectorAll('.rps-choice-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            if (!rpsGameId) return;
            document.querySelectorAll('.rps-choice-btn').forEach(b => {
                b.disabled = true;
                b.classList.add('disabled');
            });
            btn.classList.remove('disabled');
            btn.classList.add('selected');
            document.getElementById('rps-waiting').classList.remove('hidden');
            socket.emit('rps_choice', {
                game_id: rpsGameId,
                choice: btn.dataset.choice,
                session_id: sessionId,
            });
        });
    });

    socket.on('rps_result', (data) => {
        if (data.session_a !== sessionId && data.session_b !== sessionId) return;
        document.getElementById('rps-game-modal').classList.add('hidden');

        if (data.result === 'cancelled') {
            showToast(data.message || 'Game cancelled', 'info');
            rpsGameId = null;
            return;
        }

        const isA = data.session_a === sessionId;
        const myChoice = isA ? data.choice_a : data.choice_b;
        const theirChoice = isA ? data.choice_b : data.choice_a;
        const opponentSession = isA ? data.session_b : data.session_a;

        const resultIcon = document.getElementById('rps-result-icon');
        const resultTitle = document.getElementById('rps-result-title');
        const resultDrink = document.getElementById('rps-result-drink');

        if (data.result === 'tie') {
            resultIcon.textContent = 'ü§ù';
            resultTitle.textContent = "It's a tie!";
            resultTitle.className = 'rps-result-title rps-result-tie';
        } else if (data.result === 'win') {
            resultIcon.textContent = 'üéâ';
            resultTitle.textContent = 'You won!';
            resultTitle.className = 'rps-result-title rps-result-win';
        } else {
            resultIcon.textContent = 'üòî';
            resultTitle.textContent = 'You lost!';
            resultTitle.className = 'rps-result-title rps-result-lose';
        }

        document.getElementById('rps-result-yours').textContent = myChoice ? choiceEmoji[myChoice] : '‚è∞';
        document.getElementById('rps-result-theirs').textContent = theirChoice ? choiceEmoji[theirChoice] : '‚è∞';
        document.getElementById('rps-result-them-label').textContent = userName(opponentSession);

        if (data.mode === 'drink' && data.drink && data.result !== 'tie') {
            resultDrink.classList.remove('hidden', 'drink-winner', 'drink-loser');
            if (data.result === 'win') {
                resultDrink.classList.add('drink-winner');
                resultDrink.textContent = `Go to the bar to collect your drink from ${userName(data.loser)}!`;
            } else {
                resultDrink.classList.add('drink-loser');
                resultDrink.textContent = `Go to the bar now and buy ${userName(data.winner)} a drink!`;
            }
        } else {
            resultDrink.classList.add('hidden');
        }

        document.getElementById('rps-result-modal').classList.remove('hidden');
        rpsGameId = null;
    });

    document.getElementById('rps-result-close').addEventListener('click', () => {
        document.getElementById('rps-result-modal').classList.add('hidden');
    });

    // ===== Bomb Pass =====
    let bombGameId = null;
    let bombOpponentSession = null;
    let bombIsAnimating = false;

    document.getElementById('bomb-btn').addEventListener('click', () => {
        document.getElementById('action-step').classList.add('hidden');
        document.getElementById('rps-setup-step').classList.add('hidden');
        document.getElementById('tap-setup-step').classList.add('hidden');
        document.getElementById('ttol-setup-step').classList.add('hidden');
        document.getElementById('bomb-setup-step').classList.remove('hidden');
    });

    document.querySelectorAll('.bomb-mode-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const mode = btn.dataset.mode;
            socket.emit('bomb_challenge', {
                to_session: targetSession,
                mode: mode,
                drink: mode === 'drink' ? 'drink' : '',
            });
            closeActionModal();
            showChallengeWaiting(userName(targetSession), 'Bomb Pass');
        });
    });

    socket.on('bomb_error', (data) => { hideChallengeWaiting(); showToast(data.message, 'error'); });

    socket.on('bomb_declined', (data) => {
        hideChallengeWaiting();
        showToast(`${userName(data.from_session)} declined your Bomb Pass`, 'info');
    });

    socket.on('bomb_incoming', (data) => {
        bombGameId = data.game_id;
        const modeText = data.mode === 'drink' ? 'Loser buys the winner a drink!' : 'Just for fun!';
        const bombPhoto = document.getElementById('bomb-incoming-photo');
        bombPhoto.className = 'incoming-photo hidden';
        if (data.from_photo) {
            bombPhoto.src = data.from_photo;
            bombPhoto.classList.remove('hidden');
            const profile = userProfiles[data.from_session];
            if (profile && profile.color_frame) bombPhoto.classList.add(`frame-${profile.color_frame}`);
        }
        const challenger = data.from_name || userName(data.from_session);
        document.getElementById('bomb-incoming-message').textContent =
            `${challenger} challenges you to Bomb Pass!`;
        document.getElementById('bomb-incoming-detail').textContent = modeText;
        document.getElementById('bomb-incoming-modal').classList.remove('hidden');
        if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
        sendBrowserNotification('Bomb Pass Challenge!', `${challenger} wants to play! ${modeText}`);
    });

    document.getElementById('bomb-accept-btn').addEventListener('click', () => {
        document.getElementById('bomb-incoming-modal').classList.add('hidden');
        socket.emit('bomb_response', { game_id: bombGameId, accepted: true });
    });

    document.getElementById('bomb-decline-btn').addEventListener('click', () => {
        document.getElementById('bomb-incoming-modal').classList.add('hidden');
        socket.emit('bomb_response', { game_id: bombGameId, accepted: false });
        bombGameId = null;
    });

    function setBombPosition(holder, animate) {
        const isHolding = holder === sessionId;
        const emoji = document.getElementById('bomb-emoji');
        const statusText = document.getElementById('bomb-status-text');
        const passBtn = document.getElementById('bomb-pass-btn');
        const waiting = document.getElementById('bomb-waiting');
        const playerYou = document.getElementById('bomb-player-you');
        const playerThem = document.getElementById('bomb-player-them');

        if (animate && !bombIsAnimating) {
            bombIsAnimating = true;
            const throwClass = isHolding ? 'bomb-throw-right-to-left' : 'bomb-throw-left-to-right';
            emoji.classList.remove('bomb-shake', 'bomb-safe', 'bomb-at-you', 'bomb-at-them',
                'bomb-throw-left-to-right', 'bomb-throw-right-to-left');
            emoji.offsetHeight;
            emoji.classList.add(throwClass);
            setTimeout(() => {
                emoji.classList.remove(throwClass);
                bombIsAnimating = false;
                applyBombState(isHolding, emoji, statusText, passBtn, waiting, playerYou, playerThem);
            }, 400);
        } else {
            applyBombState(isHolding, emoji, statusText, passBtn, waiting, playerYou, playerThem);
        }
    }

    function applyBombState(isHolding, emoji, statusText, passBtn, waiting, playerYou, playerThem) {
        emoji.classList.remove('bomb-shake', 'bomb-safe', 'bomb-at-you', 'bomb-at-them');
        if (isHolding) {
            emoji.classList.add('bomb-shake', 'bomb-at-you');
            statusText.textContent = "You're holding the bomb!";
            statusText.className = 'bomb-status-text bomb-status-danger';
            passBtn.classList.remove('hidden');
            waiting.classList.add('hidden');
            playerYou.classList.add('bomb-player-active');
            playerThem.classList.remove('bomb-player-active');
        } else {
            emoji.classList.add('bomb-shake', 'bomb-at-them');
            statusText.textContent = "They're holding it...";
            statusText.className = 'bomb-status-text bomb-status-safe';
            passBtn.classList.add('hidden');
            waiting.classList.remove('hidden');
            playerYou.classList.remove('bomb-player-active');
            playerThem.classList.add('bomb-player-active');
        }
    }

    socket.on('bomb_start', (data) => {
        if (data.session_a !== sessionId && data.session_b !== sessionId) return;
        hideChallengeWaiting();
        bombGameId = data.game_id;
        bombOpponentSession = data.session_a === sessionId ? data.session_b : data.session_a;

        document.getElementById('bomb-them-label').textContent = userName(bombOpponentSession);
        const modeText = data.mode === 'drink' ? `Playing for: ${data.drink}` : 'Just for fun';
        document.getElementById('bomb-game-mode').textContent = modeText;

        const fuseBar = document.getElementById('bomb-fuse-bar');
        fuseBar.style.transition = 'none';
        fuseBar.style.width = '100%';
        fuseBar.offsetHeight;
        fuseBar.style.transition = 'width 15s linear';
        fuseBar.style.width = '0%';

        setBombPosition(data.holder, false);
        document.getElementById('bomb-game-modal').classList.remove('hidden');
        if (navigator.vibrate) navigator.vibrate(100);
    });

    document.getElementById('bomb-pass-btn').addEventListener('click', () => {
        if (!bombGameId || bombIsAnimating) return;
        socket.emit('bomb_pass', {
            game_id: bombGameId,
            session_id: sessionId,
        });
        if (navigator.vibrate) navigator.vibrate(50);
    });

    socket.on('bomb_passed', (data) => {
        setBombPosition(data.holder, true);
        if (navigator.vibrate) navigator.vibrate(50);
    });

    socket.on('bomb_result', (data) => {
        if (data.session_a !== sessionId && data.session_b !== sessionId) return;
        document.getElementById('bomb-game-modal').classList.add('hidden');

        if (data.result === 'cancelled') {
            showToast(data.message || 'Game cancelled', 'info');
            bombGameId = null;
            return;
        }

        const resultIcon = document.getElementById('bomb-result-icon');
        const resultTitle = document.getElementById('bomb-result-title');
        const resultDrink = document.getElementById('bomb-result-drink');

        if (data.result === 'win') {
            resultIcon.textContent = 'üòÖ';
            resultTitle.textContent = 'You survived!';
            resultTitle.className = 'rps-result-title rps-result-win';
        } else {
            resultIcon.textContent = 'üí•';
            resultTitle.textContent = 'BOOM! You exploded!';
            resultTitle.className = 'rps-result-title rps-result-lose';
            if (navigator.vibrate) navigator.vibrate([100, 50, 100, 50, 200]);
        }

        if (data.mode === 'drink' && data.drink) {
            resultDrink.classList.remove('hidden', 'drink-winner', 'drink-loser');
            if (data.result === 'win') {
                resultDrink.classList.add('drink-winner');
                resultDrink.textContent = `Go to the bar to collect your drink from ${userName(data.loser)}!`;
            } else {
                resultDrink.classList.add('drink-loser');
                resultDrink.textContent = `Go to the bar now and buy ${userName(data.winner)} a drink!`;
            }
        } else {
            resultDrink.classList.add('hidden');
        }

        document.getElementById('bomb-result-modal').classList.remove('hidden');
        bombGameId = null;
    });

    document.getElementById('bomb-result-close').addEventListener('click', () => {
        document.getElementById('bomb-result-modal').classList.add('hidden');
    });

    // ===== Tap Race =====
    let tapGameId = null;
    let tapOpponentSession = null;
    let tapActive = false;
    let tapMyCount = 0;

    document.getElementById('tap-btn').addEventListener('click', () => {
        document.getElementById('action-step').classList.add('hidden');
        document.getElementById('rps-setup-step').classList.add('hidden');
        document.getElementById('bomb-setup-step').classList.add('hidden');
        document.getElementById('ttol-setup-step').classList.add('hidden');
        document.getElementById('tap-setup-step').classList.remove('hidden');
    });

    document.querySelectorAll('.tap-mode-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const mode = btn.dataset.mode;
            socket.emit('tap_challenge', {
                to_session: targetSession,
                mode: mode,
                drink: mode === 'drink' ? 'drink' : '',
            });
            closeActionModal();
            showChallengeWaiting(userName(targetSession), 'Tap Race');
        });
    });

    socket.on('tap_error', (data) => { hideChallengeWaiting(); showToast(data.message, 'error'); });

    socket.on('tap_declined', (data) => {
        hideChallengeWaiting();
        showToast(`${userName(data.from_session)} declined your Tap Race`, 'info');
    });

    socket.on('tap_incoming', (data) => {
        tapGameId = data.game_id;
        const modeText = data.mode === 'drink' ? 'Loser buys the winner a drink!' : 'Just for fun!';
        const tapPhoto = document.getElementById('tap-incoming-photo');
        tapPhoto.className = 'incoming-photo hidden';
        if (data.from_photo) {
            tapPhoto.src = data.from_photo;
            tapPhoto.classList.remove('hidden');
            const profile = userProfiles[data.from_session];
            if (profile && profile.color_frame) tapPhoto.classList.add(`frame-${profile.color_frame}`);
        }
        const challenger = data.from_name || userName(data.from_session);
        document.getElementById('tap-incoming-message').textContent =
            `${challenger} challenges you to Tap Race!`;
        document.getElementById('tap-incoming-detail').textContent = modeText;
        document.getElementById('tap-incoming-modal').classList.remove('hidden');
        if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
        sendBrowserNotification('Tap Race Challenge!', `${challenger} wants to race! ${modeText}`);
    });

    document.getElementById('tap-accept-btn').addEventListener('click', () => {
        document.getElementById('tap-incoming-modal').classList.add('hidden');
        socket.emit('tap_response', { game_id: tapGameId, accepted: true });
    });

    document.getElementById('tap-decline-btn').addEventListener('click', () => {
        document.getElementById('tap-incoming-modal').classList.add('hidden');
        socket.emit('tap_response', { game_id: tapGameId, accepted: false });
        tapGameId = null;
    });

    socket.on('tap_start', (data) => {
        if (data.session_a !== sessionId && data.session_b !== sessionId) return;
        hideChallengeWaiting();
        tapGameId = data.game_id;
        tapOpponentSession = data.session_a === sessionId ? data.session_b : data.session_a;
        tapActive = false;
        tapMyCount = 0;

        document.getElementById('tap-them-label').textContent = userName(tapOpponentSession).toUpperCase();
        const modeText = data.mode === 'drink' ? `Playing for: ${data.drink}` : 'Just for fun';
        document.getElementById('tap-game-mode').textContent = modeText;

        document.getElementById('tap-count-you').textContent = '0';
        document.getElementById('tap-count-them').textContent = '0';
        document.getElementById('tap-track-you').style.height = '0%';
        document.getElementById('tap-track-them').style.height = '0%';
        document.getElementById('tap-runner-you').style.bottom = '0%';
        document.getElementById('tap-runner-them').style.bottom = '0%';

        const tapBtn = document.getElementById('tap-tap-btn');
        tapBtn.classList.add('hidden');
        tapBtn.disabled = true;

        const arena = document.getElementById('tap-arena');
        arena.classList.add('hidden');

        const bar = document.getElementById('tap-progress-bar');
        bar.style.transition = 'none';
        bar.style.width = '100%';
        bar.offsetHeight;

        const countdown = document.getElementById('tap-countdown');
        const countdownText = document.getElementById('tap-countdown-text');
        countdown.classList.remove('hidden');

        let count = 3;
        countdownText.textContent = count;
        countdownText.className = 'tap-countdown-text tap-countdown-pop';

        const countInterval = setInterval(() => {
            count--;
            if (count > 0) {
                countdownText.textContent = count;
                countdownText.classList.remove('tap-countdown-pop');
                countdownText.offsetHeight;
                countdownText.classList.add('tap-countdown-pop');
            } else if (count === 0) {
                countdownText.textContent = 'GO!';
                countdownText.classList.remove('tap-countdown-pop');
                countdownText.offsetHeight;
                countdownText.classList.add('tap-countdown-pop');
            } else {
                clearInterval(countInterval);
                countdown.classList.add('hidden');
                arena.classList.remove('hidden');
                tapBtn.classList.remove('hidden');
                tapBtn.disabled = false;
                tapActive = true;
                bar.style.transition = 'width 10s linear';
                bar.style.width = '0%';
                if (navigator.vibrate) navigator.vibrate(100);
            }
        }, 1000);

        document.getElementById('tap-game-modal').classList.remove('hidden');
    });

    const tapBtnEl = document.getElementById('tap-tap-btn');
    function handleTap(e) {
        e.preventDefault();
        if (!tapActive || !tapGameId) return;
        tapMyCount++;
        document.getElementById('tap-count-you').textContent = tapMyCount;
        const maxTaps = 150;
        const pct = Math.min((tapMyCount / maxTaps) * 100, 100);
        document.getElementById('tap-track-you').style.height = pct + '%';
        document.getElementById('tap-runner-you').style.bottom = pct + '%';

        const runner = document.getElementById('tap-runner-you');
        runner.classList.remove('tap-runner-bounce');
        runner.offsetHeight;
        runner.classList.add('tap-runner-bounce');

        const countEl = document.getElementById('tap-count-you');
        countEl.classList.remove('tap-count-bump');
        countEl.offsetHeight;
        countEl.classList.add('tap-count-bump');

        socket.emit('tap_tap', {
            game_id: tapGameId,
            session_id: sessionId,
        });
        if (navigator.vibrate) navigator.vibrate(10);
    }
    tapBtnEl.addEventListener('touchstart', handleTap, { passive: false });
    tapBtnEl.addEventListener('mousedown', handleTap);

    socket.on('tap_update', (data) => {
        const theirCount = Math.max(0, (data.count_a + data.count_b) - tapMyCount);
        document.getElementById('tap-count-them').textContent = theirCount;
        const maxTaps = 150;
        const theirPct = Math.min((theirCount / maxTaps) * 100, 100);
        document.getElementById('tap-track-them').style.height = theirPct + '%';
        document.getElementById('tap-runner-them').style.bottom = theirPct + '%';
    });

    socket.on('tap_result', (data) => {
        if (data.session_a !== sessionId && data.session_b !== sessionId) return;
        tapActive = false;
        document.getElementById('tap-game-modal').classList.add('hidden');

        const resultIcon = document.getElementById('tap-result-icon');
        const resultTitle = document.getElementById('tap-result-title');
        const resultDrink = document.getElementById('tap-result-drink');
        const resultScores = document.getElementById('tap-result-scores');

        const myScore = tapMyCount;
        const theirScore = (data.count_a + data.count_b) - tapMyCount;
        resultScores.textContent = `You: ${myScore}  vs  ${userName(tapOpponentSession)}: ${theirScore}`;

        if (data.result === 'draw') {
            resultIcon.textContent = 'ü§ù';
            resultTitle.textContent = "It's a tie!";
            resultTitle.className = 'rps-result-title';
        } else if (data.result === 'win') {
            resultIcon.textContent = 'üèÜ';
            resultTitle.textContent = 'You win!';
            resultTitle.className = 'rps-result-title rps-result-win';
        } else {
            resultIcon.textContent = 'üòÖ';
            resultTitle.textContent = 'So close!';
            resultTitle.className = 'rps-result-title rps-result-lose';
            if (navigator.vibrate) navigator.vibrate([100, 50, 100, 50, 200]);
        }

        if (data.mode === 'drink' && data.drink) {
            resultDrink.classList.remove('hidden', 'drink-winner', 'drink-loser');
            if (data.result === 'win') {
                resultDrink.classList.add('drink-winner');
                resultDrink.textContent = `Go to the bar to collect your drink from ${userName(data.loser)}!`;
            } else if (data.result === 'lose') {
                resultDrink.classList.add('drink-loser');
                resultDrink.textContent = `Go to the bar now and buy ${userName(data.winner)} a drink!`;
            } else {
                resultDrink.textContent = `It's a tie ‚Äî no one pays!`;
            }
        } else {
            resultDrink.classList.add('hidden');
        }

        document.getElementById('tap-result-modal').classList.remove('hidden');
        tapGameId = null;
    });

    document.getElementById('tap-result-close').addEventListener('click', () => {
        document.getElementById('tap-result-modal').classList.add('hidden');
    });

    // ===== 2 Truths 1 Lie =====
    let ttolGameId = null;
    let ttolOpponentSession = null;
    let ttolLieIndex = null;
    let ttolGuessIndex = null;

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // ===== How to Play =====
    const gameRules = {
        rps: {
            title: '‚úä Rock Paper Scissors',
            body: `<p><strong>How it works:</strong></p>
<p>1. Choose your mode: <em>Just for Fun</em> or <em>Play for a Drink</em> (loser buys).</p>
<p>2. Both players pick Rock, Paper, or Scissors.</p>
<p>3. Rock beats Scissors, Scissors beats Paper, Paper beats Rock.</p>
<p>4. You have <strong>30 seconds</strong> to choose or you forfeit!</p>`
        },
        bomb: {
            title: 'üí£ Bomb Pass',
            body: `<p><strong>How it works:</strong></p>
<p>1. A bomb starts with the challenger.</p>
<p>2. Tap <strong>PASS!</strong> to throw it to your opponent.</p>
<p>3. They pass it back, you pass it again ‚Äî back and forth!</p>
<p>4. The bomb has a <strong>secret fuse</strong> (8‚Äì15 seconds). Whoever is holding it when it explodes <strong>loses</strong>!</p>
<p>5. There's a 0.5s cooldown between passes ‚Äî timing is everything.</p>`
        },
        tap: {
            title: 'üëÜ Tap Race',
            body: `<p><strong>How it works:</strong></p>
<p>1. After a 3-second countdown, both players tap as fast as they can!</p>
<p>2. You have <strong>10 seconds</strong> to get the most taps.</p>
<p>3. Watch your runner race up the track with each tap.</p>
<p>4. Highest tap count wins!</p>`
        },
        ttol: {
            title: 'ü§• 2 Truths 1 Lie',
            body: `<p><strong>How it works:</strong></p>
<p>1. <strong>Write Phase</strong> (90s): Both players write 3 statements ‚Äî 2 truths and 1 lie. Tap the lie to mark it.</p>
<p>2. <strong>Guess Phase</strong> (60s): You see your opponent's 3 statements. Tap the one you think is the lie!</p>
<p>3. If you spot their lie and they miss yours ‚Äî you win! If you both guess right (or both wrong), it's a draw.</p>`
        },
    };

    document.querySelectorAll('.how-to-play-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const game = btn.dataset.game;
            const rules = gameRules[game];
            if (!rules) return;
            document.getElementById('htp-title').textContent = rules.title;
            document.getElementById('htp-body').innerHTML = rules.body;
            document.getElementById('how-to-play-modal').classList.remove('hidden');
        });
    });

    document.getElementById('how-to-play-close').addEventListener('click', () => {
        document.getElementById('how-to-play-modal').classList.add('hidden');
    });
    document.querySelector('#how-to-play-modal .modal-backdrop').addEventListener('click', () => {
        document.getElementById('how-to-play-modal').classList.add('hidden');
    });

    document.getElementById('ttol-btn').addEventListener('click', () => {
        document.getElementById('action-step').classList.add('hidden');
        document.getElementById('rps-setup-step').classList.add('hidden');
        document.getElementById('bomb-setup-step').classList.add('hidden');
        document.getElementById('tap-setup-step').classList.add('hidden');
        document.getElementById('ttol-setup-step').classList.remove('hidden');
    });

    document.querySelectorAll('.ttol-mode-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const mode = btn.dataset.mode;
            socket.emit('ttol_challenge', {
                to_session: targetSession,
                mode: mode,
                drink: mode === 'drink' ? 'drink' : '',
            });
            closeActionModal();
            showChallengeWaiting(userName(targetSession), '2 Truths 1 Lie');
        });
    });

    socket.on('ttol_error', (data) => { hideChallengeWaiting(); showToast(data.message, 'error'); });

    socket.on('ttol_declined', (data) => {
        hideChallengeWaiting();
        showToast(`${userName(data.from_session)} declined your 2 Truths 1 Lie`, 'info');
    });

    socket.on('ttol_incoming', (data) => {
        ttolGameId = data.game_id;
        const modeText = data.mode === 'drink' ? 'Loser buys the winner a drink!' : 'Just for fun!';
        const ttolPhoto = document.getElementById('ttol-incoming-photo');
        ttolPhoto.className = 'incoming-photo hidden';
        if (data.from_photo) {
            ttolPhoto.src = data.from_photo;
            ttolPhoto.classList.remove('hidden');
            const profile = userProfiles[data.from_session];
            if (profile && profile.color_frame) ttolPhoto.classList.add(`frame-${profile.color_frame}`);
        }
        const challenger = data.from_name || userName(data.from_session);
        document.getElementById('ttol-incoming-message').textContent =
            `${challenger} challenges you to 2 Truths 1 Lie!`;
        document.getElementById('ttol-incoming-detail').textContent = modeText;
        document.getElementById('ttol-incoming-modal').classList.remove('hidden');
        if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
        sendBrowserNotification('2 Truths 1 Lie!', `${challenger} wants to play! ${modeText}`);
    });

    document.getElementById('ttol-accept-btn').addEventListener('click', () => {
        document.getElementById('ttol-incoming-modal').classList.add('hidden');
        socket.emit('ttol_response', { game_id: ttolGameId, accepted: true });
    });

    document.getElementById('ttol-decline-btn').addEventListener('click', () => {
        document.getElementById('ttol-incoming-modal').classList.add('hidden');
        socket.emit('ttol_response', { game_id: ttolGameId, accepted: false });
        ttolGameId = null;
    });

    // TTOL Write Phase
    function ttolValidateForm() {
        const allFilled = [0, 1, 2].every(i =>
            document.getElementById(`ttol-stmt-${i}`).value.trim().length > 0
        );
        const lieMarked = ttolLieIndex !== null;
        const btn = document.getElementById('ttol-submit-btn');
        if (allFilled && lieMarked) {
            btn.disabled = false;
            btn.textContent = 'Submit!';
        } else {
            btn.disabled = true;
            btn.textContent = 'Fill all 3 & mark the lie';
        }
    }

    [0, 1, 2].forEach(i => {
        document.getElementById(`ttol-stmt-${i}`).addEventListener('input', ttolValidateForm);
    });

    document.querySelectorAll('.ttol-lie-toggle').forEach(btn => {
        btn.addEventListener('click', () => {
            const idx = parseInt(btn.dataset.idx);
            document.querySelectorAll('.ttol-lie-toggle').forEach(b => {
                b.textContent = '‚úì TRUTH';
                b.classList.remove('active');
            });
            document.querySelectorAll('.ttol-statement-row').forEach(r => {
                r.classList.remove('ttol-row-lie');
            });
            ttolLieIndex = idx;
            btn.textContent = '‚úó LIE';
            btn.classList.add('active');
            document.getElementById(`ttol-row-${idx}`).classList.add('ttol-row-lie');
            if (navigator.vibrate) navigator.vibrate(15);
            ttolValidateForm();
        });
    });

    socket.on('ttol_start', (data) => {
        if (data.session_a !== sessionId && data.session_b !== sessionId) return;
        hideChallengeWaiting();
        ttolGameId = data.game_id;
        ttolOpponentSession = data.session_a === sessionId ? data.session_b : data.session_a;
        ttolLieIndex = null;
        ttolGuessIndex = null;

        document.getElementById('ttol-write-vs').textContent = `vs ${userName(ttolOpponentSession)}`;
        const modeText = data.mode === 'drink' ? `Playing for: ${data.drink}` : 'Just for fun';
        document.getElementById('ttol-write-mode').textContent = modeText;

        for (let i = 0; i < 3; i++) {
            const input = document.getElementById(`ttol-stmt-${i}`);
            input.value = '';
            input.disabled = false;
        }
        document.querySelectorAll('.ttol-lie-toggle').forEach(btn => {
            btn.textContent = '‚úì TRUTH';
            btn.classList.remove('active');
            btn.disabled = false;
        });
        document.querySelectorAll('.ttol-statement-row').forEach(r => {
            r.classList.remove('ttol-row-lie');
        });
        document.getElementById('ttol-submit-btn').disabled = true;
        document.getElementById('ttol-submit-btn').textContent = 'Fill all 3 & mark the lie';
        document.getElementById('ttol-submit-btn').classList.remove('hidden');
        document.getElementById('ttol-write-waiting').classList.add('hidden');

        const bar = document.getElementById('ttol-write-timer-bar');
        bar.style.transition = 'none';
        bar.style.width = '100%';
        bar.offsetHeight;
        bar.style.transition = 'width 90s linear';
        bar.style.width = '0%';

        document.getElementById('ttol-write-modal').classList.remove('hidden');
        setTimeout(() => document.getElementById('ttol-stmt-0').focus(), 300);
    });

    document.getElementById('ttol-submit-btn').addEventListener('click', () => {
        const statements = [0, 1, 2].map(i => document.getElementById(`ttol-stmt-${i}`).value.trim());
        if (statements.some(s => s.length === 0) || ttolLieIndex === null) return;

        socket.emit('ttol_submit', {
            game_id: ttolGameId,
            session_id: sessionId,
            statements: statements,
            lie_index: ttolLieIndex,
        });

        document.getElementById('ttol-submit-btn').classList.add('hidden');
        document.getElementById('ttol-write-waiting').classList.remove('hidden');
        for (let i = 0; i < 3; i++) {
            document.getElementById(`ttol-stmt-${i}`).disabled = true;
        }
        document.querySelectorAll('.ttol-lie-toggle').forEach(btn => btn.disabled = true);
    });

    socket.on('ttol_waiting', () => {});

    // TTOL Guess Phase
    socket.on('ttol_guess_phase', (data) => {
        document.getElementById('ttol-write-modal').classList.add('hidden');
        ttolGuessIndex = null;

        document.getElementById('ttol-guess-vs').textContent =
            `${userName(data.opponent_session)}'s Statements`;

        const container = document.getElementById('ttol-guess-cards');
        container.innerHTML = data.statements.map((stmt, i) => `
            <div class="ttol-guess-card ttol-card-entrance" data-idx="${i}" style="animation-delay: ${i * 0.12}s">
                <span class="ttol-guess-card-number">${i + 1}</span>
                <span class="ttol-guess-card-text">${escapeHtml(stmt)}</span>
            </div>
        `).join('');

        container.querySelectorAll('.ttol-guess-card').forEach(card => {
            card.addEventListener('click', () => {
                ttolGuessIndex = parseInt(card.dataset.idx);
                container.querySelectorAll('.ttol-guess-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                document.getElementById('ttol-guess-btn').disabled = false;
                if (navigator.vibrate) navigator.vibrate(15);
            });
        });

        document.getElementById('ttol-guess-btn').disabled = true;
        document.getElementById('ttol-guess-btn').classList.remove('hidden');
        document.getElementById('ttol-guess-waiting').classList.add('hidden');

        const bar = document.getElementById('ttol-guess-timer-bar');
        bar.style.transition = 'none';
        bar.style.width = '100%';
        bar.offsetHeight;
        bar.style.transition = 'width 60s linear';
        bar.style.width = '0%';

        document.getElementById('ttol-guess-modal').classList.remove('hidden');
        if (navigator.vibrate) navigator.vibrate(100);
    });

    document.getElementById('ttol-guess-btn').addEventListener('click', () => {
        if (ttolGuessIndex === null) return;
        socket.emit('ttol_guess', {
            game_id: ttolGameId,
            session_id: sessionId,
            guess: ttolGuessIndex,
        });
        document.getElementById('ttol-guess-btn').classList.add('hidden');
        document.getElementById('ttol-guess-waiting').classList.remove('hidden');
        document.querySelectorAll('.ttol-guess-card').forEach(c => {
            c.style.pointerEvents = 'none';
        });
    });

    // TTOL Result
    socket.on('ttol_result', (data) => {
        if (data.session_a !== sessionId && data.session_b !== sessionId) return;
        document.getElementById('ttol-write-modal').classList.add('hidden');
        document.getElementById('ttol-guess-modal').classList.add('hidden');

        if (data.result === 'cancelled') {
            showToast(data.message || 'Game cancelled', 'info');
            ttolGameId = null;
            return;
        }

        const resultIcon = document.getElementById('ttol-result-icon');
        const resultTitle = document.getElementById('ttol-result-title');
        const resultDrink = document.getElementById('ttol-result-drink');

        if (data.result === 'draw') {
            resultIcon.textContent = 'ü§ù';
            resultTitle.textContent = "It's a draw!";
            resultTitle.className = 'rps-result-title rps-result-tie';
        } else if (data.result === 'win') {
            resultIcon.textContent = 'üéâ';
            resultTitle.textContent = 'You spotted the lie!';
            resultTitle.className = 'rps-result-title rps-result-win';
        } else {
            resultIcon.textContent = 'üòî';
            resultTitle.textContent = 'They spotted yours!';
            resultTitle.className = 'rps-result-title rps-result-lose';
            if (navigator.vibrate) navigator.vibrate([100, 50, 100, 50, 200]);
        }

        const isA = data.session_a === sessionId;
        const myStatements = isA ? data.statements_a : data.statements_b;
        const myLieIdx = isA ? data.lie_index_a : data.lie_index_b;
        const theirStatements = isA ? data.statements_b : data.statements_a;
        const theirLieIdx = isA ? data.lie_index_b : data.lie_index_a;
        const myGuess = isA ? data.guess_a : data.guess_b;
        const theirGuess = isA ? data.guess_b : data.guess_a;
        const opponentSession = isA ? data.session_b : data.session_a;

        const revealHtml = `
            <div class="ttol-reveal-section">
                <p class="ttol-reveal-label">${escapeHtml(userName(opponentSession))}'s statements:</p>
                ${theirStatements.map((s, i) => `
                    <div class="ttol-reveal-stmt ${i === theirLieIdx ? 'ttol-reveal-lie' : 'ttol-reveal-truth'}
                        ${i === myGuess ? 'ttol-reveal-guessed' : ''}"
                        style="animation-delay: ${i * 0.15}s">
                        <span class="ttol-reveal-tag">${i === theirLieIdx ? '‚úó LIE' : '‚úì TRUTH'}</span>
                        <span class="ttol-reveal-text">${escapeHtml(s)}</span>
                        ${i === myGuess ? '<span class="ttol-reveal-your-guess">üëà Your guess</span>' : ''}
                    </div>
                `).join('')}
            </div>
            <div class="ttol-reveal-section">
                <p class="ttol-reveal-label">Your statements:</p>
                ${myStatements.map((s, i) => `
                    <div class="ttol-reveal-stmt ${i === myLieIdx ? 'ttol-reveal-lie' : 'ttol-reveal-truth'}
                        ${i === theirGuess ? 'ttol-reveal-guessed' : ''}"
                        style="animation-delay: ${(i + 3) * 0.15}s">
                        <span class="ttol-reveal-tag">${i === myLieIdx ? '‚úó LIE' : '‚úì TRUTH'}</span>
                        <span class="ttol-reveal-text">${escapeHtml(s)}</span>
                        ${i === theirGuess ? '<span class="ttol-reveal-their-guess">Their guess</span>' : ''}
                    </div>
                `).join('')}
            </div>
        `;
        document.getElementById('ttol-result-reveal').innerHTML = revealHtml;

        if (data.mode === 'drink' && data.drink && data.result !== 'draw') {
            resultDrink.classList.remove('hidden', 'drink-winner', 'drink-loser');
            if (data.result === 'win') {
                resultDrink.classList.add('drink-winner');
                resultDrink.textContent = `Go to the bar to collect your drink from ${userName(data.loser)}!`;
            } else {
                resultDrink.classList.add('drink-loser');
                resultDrink.textContent = `Go to the bar now and buy ${userName(data.winner)} a drink!`;
            }
        } else {
            resultDrink.classList.add('hidden');
        }

        document.getElementById('ttol-result-modal').classList.remove('hidden');
        ttolGameId = null;
    });

    document.getElementById('ttol-result-close').addEventListener('click', () => {
        document.getElementById('ttol-result-modal').classList.add('hidden');
    });
</script>
{% endblock %}
