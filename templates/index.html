{% extends "base.html" %}

{% block title %}Welcome{% endblock %}

{% block content %}
<div class="landing-page">
    <div class="landing-header">
        <h1 class="logo">Shamrock</h1>
        <p class="tagline">Connect with people around you</p>
    </div>

    <!-- PWA Install Banner -->
    <div id="install-banner" class="install-banner hidden">
        <button id="install-dismiss" class="install-dismiss">&times;</button>
        <div id="install-android" class="hidden">
            <button id="install-btn" class="btn btn-primary" style="width:100%;gap:8px;">
                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
                Install App
            </button>
        </div>
        <div id="install-ios" class="hidden">
            <p style="margin:0;font-size:14px;color:var(--text-secondary);line-height:1.6;">
                Tap
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" style="vertical-align:middle;"><path d="M4 12v8a2 2 0 002 2h12a2 2 0 002-2v-8M16 6l-4-4-4 4M12 2v13"/></svg>
                Share, then <strong style="color:var(--text-primary);">"Add to Home Screen"</strong>
            </p>
        </div>
    </div>

    <!-- Step 0: Onboarding (first-time visitors) -->
    <div id="onboarding-step" class="onboarding-step hidden">
        <div class="onboarding-slides" id="onboarding-slides">
            <!-- Slide 1: Welcome -->
            <div class="onboarding-slide">
                <svg class="onboarding-icon" viewBox="0 0 80 80" fill="none">
                    <circle cx="40" cy="40" r="36" stroke="currentColor" stroke-width="3"/>
                    <path d="M28 42 C28 28, 52 28, 52 42" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
                    <circle cx="30" cy="34" r="3" fill="currentColor"/>
                    <circle cx="50" cy="34" r="3" fill="currentColor"/>
                </svg>
                <h2>Welcome to Shamrock</h2>
                <p>The social app for this venue. See who else is here tonight, buy them a drink straight from the menu, or challenge them to a quick game.</p>
            </div>
            <!-- Slide 2: How it works -->
            <div class="onboarding-slide">
                <svg class="onboarding-icon" viewBox="0 0 80 80" fill="none">
                    <rect x="8" y="44" width="24" height="24" rx="4" stroke="currentColor" stroke-width="2.5"/>
                    <rect x="48" y="44" width="24" height="24" rx="4" stroke="currentColor" stroke-width="2.5"/>
                    <circle cx="20" cy="56" r="5" fill="currentColor" opacity="0.5"/>
                    <circle cx="60" cy="56" r="5" fill="currentColor" opacity="0.5"/>
                    <path d="M32 52 h16" stroke="currentColor" stroke-width="2" stroke-dasharray="4 3"/>
                    <path d="M44 48 l4 4 -4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <h2>How It Works</h2>
                <div class="onboarding-steps-list">
                    <div class="onboarding-step-row">
                        <div class="onboarding-step-number">1</div>
                        <span class="onboarding-step-text">Create a quick profile so others can see you</span>
                    </div>
                    <div class="onboarding-step-row">
                        <div class="onboarding-step-number">2</div>
                        <span class="onboarding-step-text">Browse who's here and tap someone to interact</span>
                    </div>
                    <div class="onboarding-step-row">
                        <div class="onboarding-step-number">3</div>
                        <span class="onboarding-step-text">Send them a drink, a message, or a game challenge</span>
                    </div>
                </div>
            </div>
            <!-- Slide 3: What you can do -->
            <div class="onboarding-slide">
                <svg class="onboarding-icon" viewBox="0 0 80 80" fill="none">
                    <rect x="12" y="20" width="56" height="40" rx="6" stroke="currentColor" stroke-width="3"/>
                    <circle cx="30" cy="40" r="8" stroke="currentColor" stroke-width="2.5"/>
                    <circle cx="50" cy="40" r="8" stroke="currentColor" stroke-width="2.5"/>
                    <path d="M38 40h4" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
                </svg>
                <h2>What You Can Do</h2>
                <div class="onboarding-features">
                    <div class="onboarding-feature-item">
                        <span class="feat-emoji">&#x1F37A;</span>
                        <span class="feat-text">Buy a real drink from the bar and send it to someone</span>
                    </div>
                    <div class="onboarding-feature-item">
                        <span class="feat-emoji">&#x1F3AE;</span>
                        <span class="feat-text">Play Rock Paper Scissors, Bomb Pass, Tap Race, or 2 Truths 1 Lie</span>
                    </div>
                    <div class="onboarding-feature-item">
                        <span class="feat-emoji">&#x1F4AC;</span>
                        <span class="feat-text">Attach a note to your drink to break the ice</span>
                    </div>
                </div>
            </div>
            <!-- Slide 4: Enable notifications -->
            <div class="onboarding-slide">
                <svg class="onboarding-icon" viewBox="0 0 80 80" fill="none">
                    <path d="M40 8 v6" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
                    <path d="M24 60 h32" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
                    <path d="M20 60 C20 36, 22 24, 40 20 C58 24, 60 36, 60 60" stroke="currentColor" stroke-width="3"/>
                    <circle cx="40" cy="68" r="6" stroke="currentColor" stroke-width="2.5"/>
                </svg>
                <h2>Don't Miss a Thing</h2>
                <p>Get notified instantly when someone buys you a drink or challenges you to a game. Without notifications, you might miss it!</p>
                <button class="onboarding-notif-btn" id="onboarding-notif-btn">Enable Notifications</button>
                <div id="onboarding-notif-status" class="onboarding-notif-status hidden"></div>
                <div id="onboarding-notif-help" class="onboarding-notif-help hidden">
                    <p id="notif-help-text"></p>
                </div>
            </div>
        </div>
        <div class="onboarding-nav">
            <button class="onboarding-skip" id="onboarding-skip">Skip</button>
            <div class="onboarding-dots" id="onboarding-dots">
                <div class="onboarding-dot active"></div>
                <div class="onboarding-dot"></div>
                <div class="onboarding-dot"></div>
                <div class="onboarding-dot"></div>
            </div>
            <button class="onboarding-next" id="onboarding-next">Next</button>
        </div>
    </div>

    <!-- Step 1: Profile -->
    <div id="profile-step" class="profile-step hidden">
        <h2>Set up your profile</h2>

        <input type="text" id="profile-name" class="profile-name-input"
               placeholder="Your first name" maxlength="20" autocomplete="off">

        <div class="profile-photo-upload">
            <div class="photo-preview-wrapper">
                <div id="photo-preview" class="photo-preview">
                    <span class="photo-preview-icon">+</span>
                    <span class="photo-preview-text">Add Photo *</span>
                </div>
                <div id="photo-menu" class="photo-menu hidden">
                    <button type="button" id="photo-camera-btn" class="photo-menu-btn">
                        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/><circle cx="12" cy="13" r="4"/></svg>
                        Take Photo
                    </button>
                    <button type="button" id="photo-album-btn" class="photo-menu-btn">
                        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
                        Choose from Album
                    </button>
                </div>
            </div>
            <input type="file" id="profile-photo-camera" accept="image/*" capture="user" style="display:none;">
            <input type="file" id="profile-photo-album" accept="image/*" style="display:none;">
        </div>

        <input type="text" id="profile-instagram" class="profile-instagram-input"
               placeholder="Instagram handle (optional)" maxlength="30" autocomplete="off">

        <div class="color-picker-section">
            <p class="color-picker-label">Pick your frame color <span class="optional-tag">(optional)</span></p>
            <div class="color-picker-buttons">
                <button type="button" class="color-btn color-btn-red" data-color="red"></button>
                <button type="button" class="color-btn color-btn-yellow" data-color="yellow"></button>
                <button type="button" class="color-btn color-btn-green" data-color="green"></button>
            </div>
        </div>

        <div class="profile-bottom">
            <p id="profile-validation" class="profile-validation hidden"></p>
            <button id="profile-next-btn" class="btn btn-primary btn-large">
                Let's Go
            </button>
            <p class="privacy-notice">Other guests will see your name and photo</p>
        </div>
    </div>

    <!-- Step 2: Notification permission (after profile creation) -->
    <div id="notif-gate-step" class="notif-gate-step hidden">
        <div class="notif-gate-icon">
            <svg viewBox="0 0 80 80" fill="none" width="60" height="60">
                <path d="M40 8 v6" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
                <path d="M24 60 h32" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
                <path d="M20 60 C20 36, 22 24, 40 20 C58 24, 60 36, 60 60" stroke="currentColor" stroke-width="3"/>
                <circle cx="40" cy="68" r="6" stroke="currentColor" stroke-width="2.5"/>
            </svg>
        </div>
        <h2 class="notif-gate-title">One more thing!</h2>
        <p class="notif-gate-text">Turn on notifications so you know when someone buys you a drink or invites you to play a game!</p>
        <p class="notif-gate-urgency">Without notifications, you'll miss it!</p>
        <button id="notif-gate-btn" class="btn btn-primary btn-large notif-gate-btn">Enable Notifications</button>
        <div id="notif-gate-status" class="notif-gate-status hidden"></div>
        <div id="notif-gate-help" class="notif-gate-help hidden">
            <p id="notif-gate-help-text"></p>
        </div>
        <button id="notif-gate-skip" class="notif-gate-skip">Continue without notifications</button>
    </div>

    <div id="error-message" class="error-message hidden"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // ===== Hidden Admin Trigger (5 taps on logo) =====
    (function() {
        const logo = document.querySelector('.logo');
        let tapCount = 0;
        let tapTimer = null;
        logo.addEventListener('click', () => {
            tapCount++;
            clearTimeout(tapTimer);
            if (tapCount >= 5) {
                tapCount = 0;
                window.location.href = '/admin';
                return;
            }
            tapTimer = setTimeout(() => { tapCount = 0; }, 2000);
        });
    })();

    // ===== PWA Install Prompt =====
    let deferredPrompt = null;
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;

    if (!isStandalone && !localStorage.getItem('shamrockDismissInstall')) {
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        const banner = document.getElementById('install-banner');

        if (isIOS) {
            // iOS: show manual instructions
            document.getElementById('install-ios').classList.remove('hidden');
            banner.classList.remove('hidden');
        }

        // Android/Chrome: capture beforeinstallprompt
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('install-android').classList.remove('hidden');
            banner.classList.remove('hidden');
        });

        document.getElementById('install-btn').addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const result = await deferredPrompt.userChoice;
                if (result.outcome === 'accepted') banner.classList.add('hidden');
                deferredPrompt = null;
            }
        });

        document.getElementById('install-dismiss').addEventListener('click', () => {
            banner.classList.add('hidden');
            localStorage.setItem('shamrockDismissInstall', '1');
        });
    }

    // ===== Onboarding carousel =====
    (function() {
        const slides = document.getElementById('onboarding-slides');
        const dots = document.querySelectorAll('#onboarding-dots .onboarding-dot');
        const nextBtn = document.getElementById('onboarding-next');
        const skipBtn = document.getElementById('onboarding-skip');
        let current = 0;
        const total = 4;

        function goToSlide(i) {
            current = i;
            slides.style.transform = 'translateX(-' + (i * 100) + '%)';
            dots.forEach(function(d, idx) {
                d.classList.toggle('active', idx === i);
            });
            nextBtn.textContent = (i === total - 1) ? 'Get Started' : 'Next';
        }

        function finishOnboarding() {
            localStorage.setItem('shamrockOnboarded', '1');
            document.getElementById('onboarding-step').classList.add('hidden');
            document.getElementById('profile-step').classList.remove('hidden');
        }

        nextBtn.addEventListener('click', function() {
            if (current < total - 1) goToSlide(current + 1);
            else finishOnboarding();
        });

        skipBtn.addEventListener('click', finishOnboarding);

        // Touch swipe support
        var touchStartX = 0;
        slides.addEventListener('touchstart', function(e) {
            touchStartX = e.changedTouches[0].screenX;
        }, { passive: true });
        slides.addEventListener('touchend', function(e) {
            var diff = touchStartX - e.changedTouches[0].screenX;
            if (Math.abs(diff) > 50) {
                if (diff > 0 && current < total - 1) goToSlide(current + 1);
                else if (diff < 0 && current > 0) goToSlide(current - 1);
            }
        }, { passive: true });

        // ===== Notification permission (slide 4) =====
        var notifBtn = document.getElementById('onboarding-notif-btn');
        var notifStatus = document.getElementById('onboarding-notif-status');
        var notifHelp = document.getElementById('onboarding-notif-help');
        var notifHelpText = document.getElementById('notif-help-text');

        var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        var isAndroid = /Android/.test(navigator.userAgent);
        var isPWA = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;

        // Check if notifications are supported
        if (!('Notification' in window)) {
            // iOS non-PWA: notifications only work as installed PWA
            if (isIOS && !isPWA) {
                notifBtn.textContent = 'How to Enable';
                notifBtn.addEventListener('click', function() {
                    notifBtn.classList.add('hidden');
                    notifHelp.classList.remove('hidden');
                    notifHelpText.innerHTML =
                        '<strong>iPhone / iPad:</strong><br>' +
                        '1. Tap the <strong>Share</strong> button at the bottom of Safari<br>' +
                        '2. Tap <strong>"Add to Home Screen"</strong><br>' +
                        '3. Open the app from your home screen<br>' +
                        '4. You\'ll be prompted to allow notifications';
                });
            } else {
                notifBtn.textContent = 'Not Supported';
                notifBtn.disabled = true;
                notifBtn.style.opacity = '0.5';
                notifHelp.classList.remove('hidden');
                notifHelpText.textContent = 'Your browser does not support notifications. Try using Chrome or Safari.';
            }
        } else if (Notification.permission === 'granted') {
            notifBtn.textContent = 'Notifications Enabled';
            notifBtn.disabled = true;
            notifBtn.style.opacity = '0.7';
            notifStatus.textContent = 'You\'re all set!';
            notifStatus.classList.remove('hidden');
            notifStatus.classList.add('notif-granted');
        } else if (Notification.permission === 'denied') {
            notifBtn.textContent = 'Blocked';
            notifBtn.disabled = true;
            notifBtn.style.opacity = '0.5';
            notifHelp.classList.remove('hidden');
            if (isIOS) {
                notifHelpText.innerHTML =
                    '<strong>Notifications are blocked.</strong> To fix:<br>' +
                    '1. Open <strong>Settings</strong> on your device<br>' +
                    '2. Scroll down and tap <strong>Safari</strong> (or the app name if installed)<br>' +
                    '3. Tap <strong>Notifications</strong><br>' +
                    '4. Toggle notifications <strong>ON</strong>';
            } else if (isAndroid) {
                notifHelpText.innerHTML =
                    '<strong>Notifications are blocked.</strong> To fix:<br>' +
                    '1. Tap the <strong>lock icon</strong> in the address bar<br>' +
                    '2. Tap <strong>Permissions</strong><br>' +
                    '3. Set Notifications to <strong>Allow</strong>';
            } else {
                notifHelpText.innerHTML =
                    '<strong>Notifications are blocked.</strong> To fix:<br>' +
                    '1. Click the <strong>lock icon</strong> next to the URL<br>' +
                    '2. Find <strong>Notifications</strong><br>' +
                    '3. Change to <strong>Allow</strong>, then reload';
            }
        } else {
            // permission === 'default' — can request
            notifBtn.addEventListener('click', function() {
                Notification.requestPermission().then(function(perm) {
                    if (perm === 'granted') {
                        notifBtn.textContent = 'Notifications Enabled';
                        notifBtn.disabled = true;
                        notifBtn.style.opacity = '0.7';
                        notifStatus.textContent = 'You\'re all set!';
                        notifStatus.classList.remove('hidden');
                        notifStatus.classList.add('notif-granted');
                        notifHelp.classList.add('hidden');
                        // Show a test notification
                        if (navigator.serviceWorker && navigator.serviceWorker.controller) {
                            navigator.serviceWorker.ready.then(function(reg) {
                                reg.showNotification('Shamrock', { body: 'Notifications enabled! You won\'t miss a thing.', icon: '/static/icon-192.png' });
                            });
                        }
                    } else if (perm === 'denied') {
                        notifBtn.textContent = 'Blocked';
                        notifBtn.disabled = true;
                        notifBtn.style.opacity = '0.5';
                        notifHelp.classList.remove('hidden');
                        if (isAndroid) {
                            notifHelpText.innerHTML =
                                '<strong>Permission was denied.</strong> To fix:<br>' +
                                '1. Tap the <strong>lock icon</strong> in the address bar<br>' +
                                '2. Tap <strong>Permissions</strong><br>' +
                                '3. Set Notifications to <strong>Allow</strong>';
                        } else {
                            notifHelpText.innerHTML =
                                '<strong>Permission was denied.</strong> To fix:<br>' +
                                '1. Click the <strong>lock icon</strong> next to the URL<br>' +
                                '2. Find <strong>Notifications</strong><br>' +
                                '3. Change to <strong>Allow</strong>, then reload';
                        }
                    }
                });
            });
        }
    })();

    // ===== Flow control =====
    const existingSession = localStorage.getItem('shamrockSession');
    const hasOnboarded = localStorage.getItem('shamrockOnboarded');

    if (existingSession) {
        // Already has a session — go straight to people page
        window.location.href = '/people';
    } else if (hasOnboarded) {
        // Returning visitor, already onboarded — show profile step
        document.getElementById('profile-step').classList.remove('hidden');
    } else {
        // First-time visitor — show onboarding
        document.getElementById('onboarding-step').classList.remove('hidden');
    }

    // ===== Profile Step =====
    const nameInput = document.getElementById('profile-name');
    const nextBtn = document.getElementById('profile-next-btn');
    const photoCameraInput = document.getElementById('profile-photo-camera');
    const photoAlbumInput = document.getElementById('profile-photo-album');
    const photoPreview = document.getElementById('photo-preview');
    const photoMenu = document.getElementById('photo-menu');
    let activePhotoInput = null; // tracks which input has the selected file
    let selectedColor = null;

    // Tapping the photo circle toggles the camera/album menu
    photoPreview.addEventListener('click', () => {
        photoMenu.classList.toggle('hidden');
    });

    // Close menu when tapping outside
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.photo-preview-wrapper')) {
            photoMenu.classList.add('hidden');
        }
    });

    // Camera button
    document.getElementById('photo-camera-btn').addEventListener('click', () => {
        photoMenu.classList.add('hidden');
        photoCameraInput.click();
    });

    // Album button
    document.getElementById('photo-album-btn').addEventListener('click', () => {
        photoMenu.classList.add('hidden');
        photoAlbumInput.click();
    });

    // Color picker
    document.querySelectorAll('.color-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            if (btn.classList.contains('selected')) {
                btn.classList.remove('selected');
                selectedColor = null;
                photoPreview.style.borderColor = '';
                photoPreview.style.borderStyle = '';
            } else {
                document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                selectedColor = btn.dataset.color;
                const colorMap = {red: '#EF4444', yellow: '#EAB308', green: '#22C55E'};
                photoPreview.style.borderColor = colorMap[selectedColor];
                photoPreview.style.borderStyle = 'solid';
            }
        });
    });

    const validationMsg = document.getElementById('profile-validation');

    // Clear validation when user fills in a field
    nameInput.addEventListener('input', () => {
        validationMsg.classList.add('hidden');
    });

    // Shared photo preview handler
    function handlePhotoSelected(input) {
        if (input.files.length > 0) {
            activePhotoInput = input;
            const reader = new FileReader();
            reader.onload = (e) => {
                photoPreview.innerHTML = `<img src="${e.target.result}" alt="Photo">`;
            };
            reader.readAsDataURL(input.files[0]);
            validationMsg.classList.add('hidden');
        }
    }

    photoCameraInput.addEventListener('change', () => handlePhotoSelected(photoCameraInput));
    photoAlbumInput.addEventListener('change', () => handlePhotoSelected(photoAlbumInput));

    // Submit profile and go to people page
    nextBtn.addEventListener('click', async () => {
        const name = nameInput.value.trim();
        const hasPhoto = activePhotoInput && activePhotoInput.files.length > 0;

        // Validate required fields
        if (!name && !hasPhoto) {
            validationMsg.textContent = 'Please enter your name and add a photo';
            validationMsg.classList.remove('hidden');
            nameInput.focus();
            return;
        }
        if (!name) {
            validationMsg.textContent = 'Please enter your name';
            validationMsg.classList.remove('hidden');
            nameInput.focus();
            return;
        }
        if (!hasPhoto) {
            validationMsg.textContent = 'Please add a photo so others can recognize you';
            validationMsg.classList.remove('hidden');
            return;
        }

        nextBtn.disabled = true;
        nextBtn.textContent = 'Saving...';

        const sessionId = 'session_' + Math.random().toString(36).substr(2, 9);

        const instagram = document.getElementById('profile-instagram').value.trim().replace(/^@/, '');

        const formData = new FormData();
        formData.append('session_id', sessionId);
        formData.append('name', name);
        formData.append('photo', activePhotoInput.files[0]);
        if (selectedColor) {
            formData.append('color_frame', selectedColor);
        }
        if (instagram) {
            formData.append('instagram', instagram);
        }

        try {
            const res = await fetch('/api/profile', { method: 'POST', body: formData });
            const data = await res.json();
            if (data.success) {
                localStorage.setItem('shamrockSession', sessionId);
                localStorage.setItem('shamrockProfileName', name);
                if (data.photo_url) {
                    localStorage.setItem('shamrockProfilePhoto', data.photo_url);
                }
                if (data.color_frame) {
                    localStorage.setItem('shamrockColorFrame', data.color_frame);
                }
                // Show notification gate if permission not yet granted
                if ('Notification' in window && Notification.permission === 'default') {
                    document.getElementById('profile-step').classList.add('hidden');
                    showNotifGate();
                } else {
                    window.location.href = '/people';
                }
            } else {
                const errorEl = document.getElementById('error-message');
                errorEl.textContent = data.error || 'Failed to save profile';
                errorEl.classList.remove('hidden');
                setTimeout(() => errorEl.classList.add('hidden'), 3000);
                nextBtn.disabled = false;
                nextBtn.textContent = "Let's Go";
            }
        } catch (e) {
            console.error('Profile creation failed:', e);
            nextBtn.disabled = false;
            nextBtn.textContent = "Let's Go";
        }
    });

    // ===== Notification Gate (after profile creation) =====
    function showNotifGate() {
        const gate = document.getElementById('notif-gate-step');
        gate.classList.remove('hidden');

        const btn = document.getElementById('notif-gate-btn');
        const skipBtn = document.getElementById('notif-gate-skip');
        const statusEl = document.getElementById('notif-gate-status');
        const helpEl = document.getElementById('notif-gate-help');
        const helpText = document.getElementById('notif-gate-help-text');

        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        const isAndroid = /Android/.test(navigator.userAgent);

        btn.addEventListener('click', () => {
            Notification.requestPermission().then((perm) => {
                if (perm === 'granted') {
                    btn.textContent = 'Notifications Enabled!';
                    btn.disabled = true;
                    statusEl.textContent = "You're all set!";
                    statusEl.classList.remove('hidden');
                    statusEl.classList.add('notif-granted');
                    if (navigator.serviceWorker && navigator.serviceWorker.controller) {
                        navigator.serviceWorker.ready.then((reg) => {
                            reg.showNotification('Shamrock', {
                                body: "Notifications on! You won't miss a thing.",
                                icon: '/static/icon-192.png'
                            });
                        });
                    }
                    setTimeout(() => { window.location.href = '/people'; }, 1200);
                } else if (perm === 'denied') {
                    btn.textContent = 'Blocked';
                    btn.disabled = true;
                    btn.style.opacity = '0.5';
                    helpEl.classList.remove('hidden');
                    if (isIOS) {
                        helpText.innerHTML =
                            '<strong>Permission was denied.</strong> To fix:<br>' +
                            '1. Open <strong>Settings</strong> on your device<br>' +
                            '2. Scroll down to <strong>Safari</strong><br>' +
                            '3. Tap <strong>Notifications</strong> → toggle ON';
                    } else if (isAndroid) {
                        helpText.innerHTML =
                            '<strong>Permission was denied.</strong> To fix:<br>' +
                            '1. Tap the <strong>lock icon</strong> in the address bar<br>' +
                            '2. Tap <strong>Permissions</strong><br>' +
                            '3. Set Notifications to <strong>Allow</strong>';
                    } else {
                        helpText.innerHTML =
                            '<strong>Permission was denied.</strong> To fix:<br>' +
                            '1. Click the <strong>lock icon</strong> next to the URL<br>' +
                            '2. Find <strong>Notifications</strong> → change to <strong>Allow</strong>';
                    }
                }
            });
        });

        skipBtn.addEventListener('click', () => {
            window.location.href = '/people';
        });
    }
</script>
{% endblock %}
